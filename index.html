<!DOCTYPE html>
<html lang="fr"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <title>Exercice Hiragana (JSON)</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; text-align: center; }
    .instruction { font-size: 1.2em; margin-bottom: 10px; }
    .grid-container { display: grid; gap: 5px; justify-content: center; margin-bottom: 5px; width: fit-content; margin-left: auto; margin-right: auto; }
    .romaji-box { height: 20px; font-size: 14px; line-height: 20px; text-align: center; width: 40px; }
    .box { width: 40px; height: 40px; border: 2px solid #333; font-size: 24px; line-height: 40px; background-color: white; text-align: center; }
    .box.correct { background-color: #c8f7c5; }
    .box.incorrect { background-color: #f9c0c0; }
    #buttons { margin-top: 10px; }
    #buttons button { margin: 5px; font-size: 20px; padding: 5px 10px; }
    #buttons button:disabled { background-color: #d0e6ff; color: #555; }
    .buttons { margin-top: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .buttons button { font-size: 24px; padding: 12px 24px; border-radius: 10px; background-color: #eeeeee; border: 2px solid #aaa; }
    .buttons button:hover { background-color: #d8eaff; cursor: pointer; }
    .feedback { font-weight: bold; font-size: 1.2em; margin-top: 15px; }
    /* Styling for the instruction lines: romaji (normal), Japanese (red) and hidden by default, and French (dark blue) */
    .romaji-line {
      font-style: normal;
      font-weight: normal;
    }
    .jp-line {
      color: red;
      font-weight: normal;
      display: none; /* hidden until the user provides a correct answer */
    }
    .fr-line {
      color: #00008B;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <div class="instruction" id="instruction"><p>Erreur de chargement des donn√©es.</p></div>
  <!-- Removed the standalone jpPhrase element because the Japanese text will now be
       displayed inside the instruction block itself when appropriate. -->
  <!-- <div class="feedback" id="jpPhrase" style="color: red;"></div> -->
  <div class="grid-container" id="romaji-container"></div>
  <div class="grid-container" id="phrase-container"></div>
  <div id="buttons"></div>
  <div class="buttons">
    <button id="checkButton" onclick="checkAnswer()" disabled="disabled">V√©rifier</button>
    <button onclick="clearBoxes()">RAZ</button>
    <button onclick="undoLast()">‚Üê</button>
    <button id="hintButton" onmousedown="showHint()" onmouseup="hideHint()" ontouchstart="showHint()" ontouchend="hideHint()">üí°</button>
    <button onclick="nextPhrase()">Phrase suivante</button>
  </div>
  <div class="feedback" id="feedback"></div>
  
  <div class="feedback">Aides utilis√©es : <span id="hintCount">0</span></div>

  <script>
    let phrases = [], currentIndex = 0, boxes = [], romajiBoxes = [], clickHistory = [], hintCount = 0;
    let hintActive = false, lastHintedBox = null;

    const phraseContainer = document.getElementById('phrase-container');
    const romajiContainer = document.getElementById('romaji-container');
    const buttonsContainer = document.getElementById('buttons');
    const instruction = document.getElementById('instruction');
    const feedback = document.getElementById('feedback');
    const hintCountSpan = document.getElementById('hintCount');
    const checkButton = document.getElementById('checkButton');
    const clickAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAD//f39/f39");

    const charToRomaji = {
      '„ÅÇ':'a','„ÅÑ':'i','„ÅÜ':'u','„Åà':'e','„Åä':'o','„Åã':'ka','„Åç':'ki','„Åè':'ku','„Åë':'ke','„Åì':'ko',
      '„Åå':'ga','„Åé':'gi','„Åê':'gu','„Åí':'ge','„Åî':'go','„Åï':'sa','„Åó':'shi','„Åô':'su','„Åõ':'se','„Åù':'so',
      '„Åñ':'za','„Åò':'ji','„Åö':'zu','„Åú':'ze','„Åû':'zo','„Åü':'ta','„Å°':'chi','„Å§':'tsu','„Å¶':'te','„Å®':'to',
      '„Å†':'da','„Åß':'de','„Å©':'do','„Å™':'na','„Å´':'ni','„Å¨':'nu','„Å≠':'ne','„ÅÆ':'no','„ÅØ':'ha','„Å≤':'hi',
      '„Åµ':'fu','„Å∏':'he','„Åª':'ho','„Å∞':'ba','„Å≥':'bi','„Å∂':'bu','„Åπ':'be','„Åº':'bo','„Åæ':'ma','„Åø':'mi',
      '„ÇÄ':'mu','„ÇÅ':'me','„ÇÇ':'mo','„ÇÑ':'ya','„ÇÜ':'yu','„Çà':'yo','„Çâ':'ra','„Çä':'ri','„Çã':'ru','„Çå':'re',
      '„Çç':'ro','„Çè':'wa','„Çí':'o','„Çì':'n','„Å£':'','„ÇÉ':'ya','„ÇÖ':'yu','„Çá':'yo','„Éº':'', '„Äú':'',
      '„Éï':'fu','„É©':'ra','„É≥':'n','„Çπ':'su','„Ç∏':'ji','„Éß':'yo','„Éà':'to','„Ç´':'ka','„Éâ':'do'
    };

    function hiraganaToRomajiCluster(cluster) {
      return cluster.split('').map(c => charToRomaji[c] || '').join('');
    }

    function loadPhrase(index) {
      const phrase = phrases[index];
      const rawChars = phrase.kana.trim().split(' ');
      const romajiList = rawChars.map(hiraganaToRomajiCluster);
      boxes = []; romajiBoxes = []; clickHistory = [];
      hintCount = 0;
      hintCountSpan.textContent = hintCount;
      feedback.textContent = '';
      // Hide any previously displayed Japanese phrase at the start of a new phrase.
      const jpReset = document.getElementById('jpPhrase');
      if (jpReset) {
        jpReset.textContent = '';
        jpReset.style.display = 'none';
      }
      checkButton.disabled = true;
      // Construct the instruction block with romaji, a placeholder for the Japanese phrase,
      // and the French translation. The Japanese line remains hidden until the answer
      // is validated as correct.
      instruction.innerHTML =
        `<p class="romaji-line">${phrase.romaji}</p>` +
        `<p id="jpPhrase" class="jp-line"></p>` +
        `<p class="fr-line">${phrase.fr}</p>`;

      phraseContainer.style.gridTemplateColumns = `repeat(${rawChars.length}, 40px)`;
      romajiContainer.style.gridTemplateColumns = `repeat(${rawChars.length}, 40px)`;
      phraseContainer.innerHTML = ''; romajiContainer.innerHTML = ''; buttonsContainer.innerHTML = '';

      rawChars.forEach((_, i) => {
        const rBox = document.createElement('div');
        rBox.className = 'romaji-box';
        romajiContainer.appendChild(rBox);
        romajiBoxes.push(rBox);
        const box = document.createElement('div');
        box.className = 'box';
        phraseContainer.appendChild(box);
        boxes.push(box);
      });

      const shuffled = rawChars.slice().sort(() => Math.random() - 0.5);
      shuffled.forEach(char => {
        const btn = document.createElement('button');
        btn.textContent = char;
        btn.onclick = () => { clickAudio.play(); insertCharacter(char, btn); };
        buttonsContainer.appendChild(btn);
      });

      boxes.correct = rawChars;
      boxes.romajiList = romajiList;
    }

    function insertCharacter(char, button) {
      const emptyBox = boxes.find(b => b.textContent === '');
      if (emptyBox) {
        emptyBox.textContent = char;
        button.disabled = true;
        clickHistory.push({box: emptyBox, button});
        updateCheckButtonState();
      }
    }

    function updateCheckButtonState() {
      checkButton.disabled = !boxes.every(b => b.textContent !== '');
    }

    function checkAnswer() {
      boxes.forEach((box, i) => {
        box.classList.remove('correct', 'incorrect');
        if (box.textContent === boxes.correct[i]) {
          box.classList.add('correct');
          romajiBoxes[i].textContent = boxes.romajiList[i] || '';
        } else {
          box.classList.add('incorrect');
          romajiBoxes[i].textContent = '';
        }
      });
      const result = boxes.map(b => b.textContent).join('') === boxes.correct.join('');
      feedback.textContent = result ? '‚úÖ Bravo !' : '‚ùå Essaie encore';
      // Display the Japanese phrase only if the answer is correct.
      const jpElement = document.getElementById('jpPhrase');
      if (result) {
        jpElement.textContent = phrases[currentIndex].jp;
        jpElement.style.display = 'block';
      } else {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    function clearBoxes() {
      boxes.forEach((box, i) => {
        box.textContent = '';
        box.classList.remove('correct', 'incorrect');
        romajiBoxes[i].textContent = '';
      });
      document.querySelectorAll('#buttons button').forEach(b => b.disabled = false);
      clickHistory = [];
      feedback.textContent = '';
      // Hide the Japanese phrase when clearing the boxes.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      updateCheckButtonState();
    }

    function undoLast() {
      const last = clickHistory.pop();
      if (last) {
        const idx = boxes.indexOf(last.box);
        last.box.textContent = '';
        romajiBoxes[idx].textContent = '';
        last.box.classList.remove('correct', 'incorrect');
        last.button.disabled = false;
        updateCheckButtonState();
      }
      // Hide the Japanese phrase whenever the user interacts with the undo button.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    function showHint() {
      // Hide the Japanese phrase when requesting a hint.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      const i = boxes.findIndex(b => b.textContent === '');
      if (i !== -1) {
        lastHintedBox = boxes[i];
        lastHintedBox.textContent = boxes.correct[i];
        lastHintedBox.style.opacity = '0.5';
        hintCount++;
        hintCountSpan.textContent = hintCount;
        hintActive = true;
      }
    }

    function hideHint() {
      if (hintActive && lastHintedBox) {
        lastHintedBox.textContent = '';
        lastHintedBox.style.opacity = '1';
        lastHintedBox = null;
        hintActive = false;
      }
      // Hide the Japanese phrase when the hint is released.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    function nextPhrase() {
      currentIndex = (currentIndex + 1) % phrases.length;
      loadPhrase(currentIndex);
      // Hide the Japanese phrase when moving to the next phrase.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    fetch("phrases_100.json")
      .then(res => res.json())
      .then(json => { phrases = json; loadPhrase(currentIndex); })
      .catch(e => { instruction.innerHTML = "<p>Erreur de chargement des donn√©es.</p>"; console.error(e); });
  </script>


</body></html>
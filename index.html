<!DOCTYPE html>
<html lang="fr"><head>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" name="viewport">
<meta content="text/html; charset=UTF-8" http-equiv="content-type">
<meta charset="utf-8">
<!-- Mise √† jour du titre de la page pour refl√©ter l'exercice avec un drapeau japonais -->
<title>Hiragana </title>
<style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; text-align: center; }
    .instruction { font-size: 1.2em; margin-bottom: 10px; }
    /*
      The container that holds the romaji and hiragana boxes was previously defined
      as a grid with a fixed number of columns. On narrower screens (and even on
      desktop when the answer contains many characters) this caused the row of
      boxes to overflow off the right side of the page. To allow the boxes to
      wrap naturally when there isn‚Äôt enough horizontal space, switch this
      container to use flexbox with wrapping enabled. Each box still has a
      fixed width (40px), so flexbox will automatically break to a new line
      whenever a row is full. The container width is set to 100% to ensure it
      doesn't grow beyond the viewport, preventing overflow, and centering is
      maintained with auto margins.
    */
    .grid-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
      margin-bottom: 5px;
      width: 100%;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    .romaji-box { height: 20px; font-size: 14px; line-height: 20px; text-align: center; width: 40px; }
    .box { width: 40px; height: 40px; border: 2px solid #333; font-size: 24px; line-height: 40px; background-color: white; text-align: center; }
    .box.correct { background-color: #c8f7c5; }
    .box.incorrect { background-color: #f9c0c0; }
    #buttons { margin-top: 10px; }
    #buttons button { margin: 5px; font-size: 20px; padding: 5px 10px; }
    #buttons button:disabled { background-color: #d0e6ff; color: #555; }
    .buttons { margin-top: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .buttons button { font-size: 24px; padding: 12px 24px; border-radius: 10px; background-color: #eeeeee; border: 2px solid #aaa; }
    .buttons button:hover { background-color: #d8eaff; cursor: pointer; }
    .feedback { font-weight: bold; font-size: 1.2em; margin-top: 15px; }
    /* Style pour le titre principal de la page */
    h1#appTitle {
      font-size: 2em;
      margin-bottom: 20px;
    }
    #appTitle {
      text-align: center;
      margin-bottom: 20px;
    }

    .title-main {
      font-size: 2em;
      font-weight: bold;
    }

    .title-signature {
      font-size: 0.9em;
      color: #666;
      font-family: serif;
      opacity: 0.8;
      margin-top: 4px; 
    }

    /* Indicateur discret de position de la phrase */
    .phrase-counter {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
    }
    /* Styling for the instruction lines: romaji (normal), Japanese (red) and hidden by default, and French (dark blue) */
    .romaji-line {
      font-style: normal;
      font-weight: normal;
    }
    .jp-line {
      color: red;
      font-weight: normal;
      display: none; /* hidden until the user provides a correct answer */
    }
    .fr-line {
      color: #00008B;
      font-weight: normal;
    }
  
    .highlight-preview {
      background-color: #fff5c2 !important;
      box-shadow: 0 0 8px #f0c040;
      transform: scale(1.05);
      transition: transform 0.1s ease;
    }
    
    .action-button {
      font-size: 1.2em;
      padding: 0.4em 1em;
      margin: 0.2em;
      border-radius: 8px;
      border: 2px solid #888;
      background-color: #f0f0f0;
      transition: background-color 0.2s ease;
    }
    .action-button:hover {
      background-color: #e0e0e0 !important;
    }
    .help-button {
      background-color: #d5f5d5 !important;
    }
    .help-button:disabled {
      background-color: #cccccc !important;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .buttons-row {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      margin-top: 30px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    @media (min-width: 600px) {
      .buttons-row {
        flex-direction: column;
        align-items: center;
      }

      .button-group {
        flex-direction: row;
        justify-content: center;
      }
    }

@media (max-width: 768px) {
  #appTitle {
    gap: 8px !important;
  }
  #appTitle .title-main {
    font-size: 1.5em !important;
  }
  .grid-container {
    transform: scale(0.95);
  }
  .buttons-row {
    flex-direction: column !important;
  }
  .button-group {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
  }
  button {
    font-size: 1em !important;
  }
}


@media screen and (max-width: 768px) and (orientation: portrait) {
  #usagePopup, #macronInfo {
    width: 95vw !important;
    left: 2.5vw !important;
    right: auto !important;
    transform: none !important;
    max-width: none !important;
    border-radius: 12px !important;
    box-sizing: border-box;
  }
}

@media (max-width: 600px) and (orientation: portrait) {
  #statsPopup, .popup {
    min-width: 92vw !important;
    left: 50% !important;
    right: auto !important;
    transform: translateX(-50%) !important;
    border-radius: 14px !important;
  }
}

@media (max-width: 600px) {
  #audioButton {
    top: 0.32em !important;
  }
}
</style>
</head>
<body>
<!-- Titre principal affich√© en haut de la page -->

<div style="position: relative; text-align: center; margin-bottom: 10px; min-height: 56px;">
  <span class="title-main" style="font-size:2em; font-weight:bold; margin:0; display:inline-block;">Hiragana</span>
  <button id="audioButton" style="position: absolute; left: 50%; transform: translateX(90px); top: -0.18em;
      font-size:1.6em; padding:2px 8px; background:none; border:none; outline:none; box-shadow:none; cursor:pointer;" title="Lire le message vocal">üéß</button>
  <!-- Bouton de bascule voix homme/femme : tr√®s compact (ic√¥nes üë©/üë®) -->
  <button id="voiceToggle" style="position: absolute; left: 50%; transform: translateX(140px); top: -0.18em;
      font-size:1.6em; padding:2px 4px; background:none; border:none; outline:none; box-shadow:none; cursor:pointer;" title="Choisir voix homme/femme">üë©</button>
  
</div>
<div style="text-align:center; margin-bottom:20px;"><div style="position: relative; display: inline-block;">
<button style="font-size:1.2em;" title="Tableaux de caract√®res japonais">üñãÔ∏è  „ÅÇ „Ç¢ Êñá ‚ñº</button>

<div id="tableauxMenu" style="display: none; position: absolute; background-color: white; min-width: 120px;
                box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1; border: 1px solid #ccc; border-radius: 6px;">
  <button onclick="window.open('nhk_hiragana.png', '_blank');" style="width:100%;  font-size:1em;  padding: 8px; padding-left: 12px; text-align: left" title="Afficher le tableau des hiragana">„ÅÇ Hiragana</button>
  <button onclick="window.open('nhk_katakana.png', '_blank');" style="width:100%;  font-size:1em;  padding: 8px; padding-left: 12px; text-align: left" title="Afficher le tableau des katakana">„Ç¢ Katakana</button>
  <button onclick="window.open('hiragana_dessins.png', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Afficher les dessins Hiragana √©coliers">„ÅÇ √©coliers</button>
  <button onclick="window.open('katakana_dessins.png', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Afficher les dessins Katakana √©coliers">„Ç¢ √©coliers</button>
  <button onclick="window.open('100_kanji.pdf', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Ouvrir la liste des 100 kanji les plus fr√©quents"><span style="color: red;">Êñá Kanji</span></button>
</div>

</div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<div style="position: relative; display: inline-block;">
<button style="font-size:1.2em;" title="Aide, infos, statistiques">üìñ  Infos ‚ñº</button>
<div id="aideMenu" style="display: none; position: absolute; background-color: white; min-width: 140px;
                box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1; border: 1px solid #ccc; border-radius: 6px;">
<!-- Premi√®re option : ouvrir la fiche d'utilisation (ancienne ic√¥ne üìã) -->
<button onclick="document.getElementById('usagePopup').style.display='block';" style="width:100%;  font-size:1em;  padding: 8px; ;  text-align: left; padding-left: 12px; text-align: left" title="Afficher la fiche d'utilisation de l'exercice">üóíÔ∏è Mode op.</button>
<!-- Autre option d'aide : lien vers le PDF NHK -->
<button onclick="window.open('nhk_le_japonais.pdf', '_blank');" style="width:100%;  font-size:1em;  padding: 8px; ;  text-align: left; padding-left: 12px; text-align: left" title="Ouvrir le PDF NHK „ÇÑ„Åï„Åó„ÅÑÊó•Êú¨Ë™û">üìï NHK PDF </button>
<!-- Ajout d'une option menant au site NHK en ligne -->
<button onclick="window.open('https://www3.nhk.or.jp/nhkworld/lesson/french/', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Visiter le site NHK web">üåê NHK web</button>
<!-- Option pour afficher la fen√™tre des statistiques -->
<button onclick="if (typeof updateStatsDisplay === 'function') updateStatsDisplay(); document.getElementById('statsPopup').style.display='block';" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Afficher les statistiques">üìà Stats</button>
</div>
</div></div>
<div class="instruction" id="instruction"><p>Erreur de chargement des donn√©es.</p></div>
<!-- Removed the standalone jpPhrase element because the Japanese text will now be
       displayed inside the instruction block itself when appropriate. -->
<!-- <div class="feedback" id="jpPhrase" style="color: red;"></div> -->
<div class="grid-container" id="romaji-container"></div>
<div class="grid-container" id="phrase-container"></div>
<div id="buttons"></div>
<div class="buttons-row">
<div class="button-group">
<!--
        Bouton ¬´¬†reprendre¬†¬ª : n'est affich√© que lorsqu'une r√©ponse erron√©e
        est d√©tect√©e lors de la v√©rification. Il se place juste √† gauche
        du bouton V√©rifier et affiche uniquement une ic√¥ne ¬´¬†üò©¬†¬ª. Au clic,
        il efface toutes les cases incorrectes et restaure les boutons de
        kana correspondants, mimant l'action d'annuler ces entr√©es.
      -->
<button class="action-button help-button" id="resumeButton" onclick="resumeIncorrect()" style="display: none;" title="R√©initialiser uniquement les erreurs">üò©</button>
<button class="action-button help-button" disabled="disabled" id="checkButton" onclick="checkAnswer()">V√©rifier</button>
<button class="action-button" id="resetButton" onclick="clearBoxes()" title="R√©initialiser la saisie"><span style="color:red">RAZ</span></button>
<button class="action-button" id="backspaceButton" onclick="undoLast()" title="Annuler la derni√®re lettre">‚Üê</button>
<button class="action-button help-button" id="hintButton" title="Afficher un indice temporaire">üí°</button>
<button class="action-button help-button" id="solutionButton" title="Afficher temporairement la solution">üëÅÔ∏è</button>
</div>
<div class="button-group">
<button class="action-button" id="prevButton" onclick="prevPhrase()" title="Phrase pr√©c√©dente">‚¨ÖÔ∏è</button>
<button class="action-button" id="nextButton" onclick="nextPhrase()" title="Phrase suivante">‚û°Ô∏è</button>
<button class="action-button" id="randomButton" onclick="randomPhrase()" title="Phrase al√©atoire">üé≤</button>
</div>
</div>
<div class="feedback" id="feedback"></div>
<!-- Indicateur discret affichant la position actuelle de la phrase -->
<div class="phrase-counter" id="phraseCounter"></div>
<div class="phrase-counter">Indices utilis√©s sur cette page : <span id="hintCount">0</span><br>
    Total solutions consult√©es : <span id="solutionCount">0</span><br>
    dont sur cette page : <span id="localSolutionCount">0</span></div>
<script>
    let phrases = [], currentIndex = 0, boxes = [], romajiBoxes = [], clickHistory = [], hintCount = 0;
    // D√©but de la page pour calculer la dur√©e √©coul√©e
    let pageStartTime = Date.now();
    // Compteurs de statistiques : succ√®s sans aide et nombre total de v√©rifications
    let successWithoutHelpCount = 0;
    let totalCheckCount = 0;
    let hintActive = false, lastHintedBox = null;

    // Statistiques suppl√©mentaires pour l'exercice
    // Nombre total d'indices utilis√©s sur l'ensemble de la session
    let globalHintTotal = 0;
    // Nombre total d'erreurs cumul√©es (lettres incorrectes) sur l'ensemble de la session
    let totalErrorCount = 0;
    // Longueur maximale d'une phrase r√©ussie sans aide et index de cette phrase
    let bestLongestLength = 0;
    let bestLongestPhraseIndex = -1;

    const phraseContainer = document.getElementById('phrase-container');
    const romajiContainer = document.getElementById('romaji-container');
    const buttonsContainer = document.getElementById('buttons');
    const instruction = document.getElementById('instruction');
    const feedback = document.getElementById('feedback');
    const hintCountSpan = document.getElementById('hintCount');
    const checkButton = document.getElementById('checkButton');
    const clickAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAD//f39/f39");
const victoryAudio = new Audio("victory.mp3");
    // √âl√©ment d'indicateur de num√©ro de phrase
    const phraseCounter = document.getElementById('phraseCounter');

    const charToRomaji = {
      '„ÅÇ':'a','„ÅÑ':'i','„ÅÜ':'u','„Åà':'e','„Åä':'o','„Åã':'ka','„Åç':'ki','„Åè':'ku','„Åë':'ke','„Åì':'ko',
      '„Åå':'ga','„Åé':'gi','„Åê':'gu','„Åí':'ge','„Åî':'go','„Åï':'sa','„Åó':'shi','„Åô':'su','„Åõ':'se','„Åù':'so',
      '„Åñ':'za','„Åò':'ji','„Åö':'zu','„Åú':'ze','„Åû':'zo','„Åü':'ta','„Å°':'chi','„Å§':'tsu','„Å¶':'te','„Å®':'to',
      '„Å†':'da','„Åß':'de','„Å©':'do','„Å™':'na','„Å´':'ni','„Å¨':'nu','„Å≠':'ne','„ÅÆ':'no','„ÅØ':'ha','„Å≤':'hi',
      '„Åµ':'fu','„Å∏':'he','„Åª':'ho','„Å∞':'ba','„Å≥':'bi','„Å∂':'bu','„Åπ':'be','„Åº':'bo','„Åæ':'ma','„Åø':'mi',
      '„ÇÄ':'mu','„ÇÅ':'me','„ÇÇ':'mo','„ÇÑ':'ya','„ÇÜ':'yu','„Çà':'yo','„Çâ':'ra','„Çä':'ri','„Çã':'ru','„Çå':'re',
      '„Çç':'ro','„Çè':'wa','„Çí':'o','„Çì':'n','„Å£':'','„ÇÉ':'ya','„ÇÖ':'yu','„Çá':'yo','„Éº':'', '„Äú':'',
      '„Éï':'fu','„É©':'ra','„É≥':'n','„Çπ':'su','„Ç∏':'ji','„Éß':'yo','„Éà':'to','„Ç´':'ka','„Éâ':'do'
    };

    function hiraganaToRomajiCluster(cluster) {
      return cluster.split('').map(c => charToRomaji[c] || '').join('');
    }

    function loadPhrase(index) {
  const backBtn = document.getElementById("backspaceButton");
  if (backBtn) backBtn.disabled = false;
  const hintBtn = document.getElementById("hintButton");
  const solBtn = document.getElementById("solutionButton");
  if (hintBtn) hintBtn.disabled = false;
  if (solBtn) solBtn.disabled = false;
  document.getElementById("hintButton").disabled = false;
  document.getElementById("solutionButton").disabled = false;
      const localSpan = document.getElementById('localSolutionCount');
      if (localSpan) localSpan.textContent = '0';
      const phrase = phrases[index];
      const rawChars = phrase.kana.trim().split(' ');
      const romajiList = rawChars.map(hiraganaToRomajiCluster);
      boxes = []; romajiBoxes = []; clickHistory = [];
      hintCount = 0;
      hintCountSpan.textContent = hintCount;
      feedback.textContent = '';
      // Hide any previously displayed Japanese phrase at the start of a new phrase.
      const jpReset = document.getElementById('jpPhrase');
      if (jpReset) {
        jpReset.textContent = '';
        jpReset.style.display = 'none';
      }
      checkButton.disabled = true;
      // Cacher le bouton "reprendre" au chargement d'une nouvelle phrase
      const resumeBtnInit = document.getElementById('resumeButton');
      if (resumeBtnInit) {
        resumeBtnInit.style.display = 'none';
      }
      // Construct the instruction block with romaji, a placeholder for the Japanese phrase,
      // and the French translation. The Japanese line remains hidden until the answer
      // is validated as correct.
      instruction.innerHTML =
        `<p class="romaji-line">${phrase.romaji}</p>` +
        `<p id="jpPhrase" class="jp-line"></p>` +
        `<p class="fr-line">${phrase.fr}</p>`;

      // Mettre √† jour l'indicateur de position de la phrase
      if (phraseCounter) {
        phraseCounter.textContent = `Phrase ${index + 1} / ${phrases.length}`;
      }

      phraseContainer.style.gridTemplateColumns = `repeat(${rawChars.length}, 40px)`;
      romajiContainer.style.gridTemplateColumns = `repeat(${rawChars.length}, 40px)`;
      phraseContainer.innerHTML = ''; romajiContainer.innerHTML = ''; buttonsContainer.innerHTML = '';

      rawChars.forEach((_, i) => {
        const rBox = document.createElement('div');
        rBox.className = 'romaji-box';
        romajiContainer.appendChild(rBox);
        romajiBoxes.push(rBox);
        const box = document.createElement('div');
        box.className = 'box';
        phraseContainer.appendChild(box);
        boxes.push(box);
      });

      const shuffled = rawChars.slice().sort(() => Math.random() - 0.5);
      shuffled.forEach(char => {
        const btn = document.createElement('button');
        btn.textContent = char;
        btn.onclick = () => { clickAudio.play(); insertCharacter(char, btn); };
        buttonsContainer.appendChild(btn);
      });

      boxes.correct = rawChars;
      boxes.romajiList = romajiList;
      // Lire automatiquement la phrase japonaise apr√®s chargement
      if (typeof window.playJapaneseAudio === 'function' && !window.popupActive) {
        window.playJapaneseAudio();
      }
    }

    function insertCharacter(char, button) {
      const emptyBox = boxes.find(b => b.textContent === '');
      if (emptyBox) {
        emptyBox.textContent = char;
        button.disabled = true;
        clickHistory.push({box: emptyBox, button});
        updateCheckButtonState();
      }
    }

    function updateCheckButtonState() {
      checkButton.disabled = !boxes.every(b => b.textContent !== '');
    }

    function checkAnswer() {
  const backBtn = document.getElementById("backspaceButton");
  const hintBtn = document.getElementById("hintButton");
  const solBtn = document.getElementById("solutionButton");
      boxes.forEach((box, i) => {
        box.classList.remove('correct', 'incorrect');
        if (box.textContent === boxes.correct[i]) {
          box.classList.add('correct');
          romajiBoxes[i].textContent = boxes.romajiList[i] || '';
        } else {
          box.classList.add('incorrect');
          romajiBoxes[i].textContent = '';
        }
      });
      const result = boxes.map(b => b.textContent).join('') === boxes.correct.join('');
      
      if (result) {
        const hintUsed = parseInt(document.getElementById('hintCount').textContent || '0');
        const solUsed = parseInt(document.getElementById('localSolutionCount').textContent || '0');
        if (hintUsed === 0 && solUsed === 0) {
          feedback.textContent = '‚úÖ Bravo, sans aide ! üëç';
          victoryAudio.play();
        } else {
          feedback.textContent = 'Mouais, trouv√© avec de l\'aide...üëé';
        }
      } else {
        feedback.textContent = '‚ùå Essaie encore';
      }
    
      // G√©rer l'affichage du bouton "reprendre" selon le r√©sultat et la pr√©sence d'erreurs.
      const resumeBtn = document.getElementById('resumeButton');
      if (!result && boxes.some(b => b.classList.contains('incorrect'))) {
        // Afficher le bouton uniquement si des cases sont incorrectes.
        if (resumeBtn) {
          resumeBtn.style.display = 'inline-block';
        }
      } else {
        if (resumeBtn) {
          resumeBtn.style.display = 'none';
        }
      }

      // Afficher la phrase japonaise seulement si tout est correct
      const jpElement = document.getElementById('jpPhrase');
      if (result) {
        jpElement.textContent = phrases[currentIndex].jp;
        jpElement.style.display = 'block';
        if (hintBtn) hintBtn.disabled = true;
        if (solBtn) solBtn.disabled = true;
        if (backBtn) backBtn.disabled = true;
      } else {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
        if (hintBtn) hintBtn.disabled = false;
        if (solBtn) solBtn.disabled = false;
        if (backBtn) backBtn.disabled = false;
      }

      // Mettre √† jour les statistiques : incr√©menter le nombre total de v√©rifications et les succ√®s sans aide
      totalCheckCount++;
      // Nombre d'indices et de solutions utilis√©s pour cette phrase
      const hintsUsedNow = parseInt(document.getElementById('hintCount').textContent || '0');
      const solutionsUsedNow = parseInt(document.getElementById('localSolutionCount').textContent || '0');
      if (result && hintsUsedNow === 0 && solutionsUsedNow === 0) {
        successWithoutHelpCount++;
      }
      // Compter le nombre d'erreurs (cases incorrectes) pour cette phrase et l'ajouter au total
      const errorsNow = boxes.filter(b => b.classList.contains('incorrect')).length;
      totalErrorCount += errorsNow;
      // Mettre √† jour la longueur maximale d'une phrase r√©ussie sans aide
      if (result && hintsUsedNow === 0 && solutionsUsedNow === 0) {
        const phraseLength = boxes.correct.length;
        if (phraseLength > bestLongestLength) {
          bestLongestLength = phraseLength;
          bestLongestPhraseIndex = currentIndex;
        }
      }
      // Mettre √† jour l'affichage dans la modale de statistiques si elle est pr√©sente (ancienne prise en charge)
      const successEl = document.getElementById('successCount');
      const totalEl = document.getElementById('totalCheckCount');
      if (successEl) successEl.textContent = successWithoutHelpCount;
      if (totalEl) totalEl.textContent = totalCheckCount;
      // Mettre √† jour l'affichage des nouvelles statistiques dynamiques
      if (typeof updateStatsDisplay === 'function') updateStatsDisplay();
    }

    function clearBoxes() {
  const backBtn = document.getElementById("backspaceButton");
  if (backBtn) backBtn.disabled = false;
  const hintBtn = document.getElementById("hintButton");
  const solBtn = document.getElementById("solutionButton");
  if (hintBtn) hintBtn.disabled = false;
  if (solBtn) solBtn.disabled = false;
  document.getElementById("hintButton").disabled = false;
  document.getElementById("solutionButton").disabled = false;
      boxes.forEach((box, i) => {
        box.textContent = '';
        box.classList.remove('correct', 'incorrect');
        romajiBoxes[i].textContent = '';
      });
      document.querySelectorAll('#buttons button').forEach(b => b.disabled = false);
      clickHistory = [];
      feedback.textContent = '';
      // Hide the Japanese phrase when clearing the boxes.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      updateCheckButtonState();

      // Masquer le bouton "reprendre" lorsque l'on r√©initialise tout
      const resumeBtn = document.getElementById('resumeButton');
      if (resumeBtn) {
        resumeBtn.style.display = 'none';
      }
    }

    function undoLast() {
      const last = clickHistory.pop();
      if (last) {
        const idx = boxes.indexOf(last.box);
        last.box.textContent = '';
        romajiBoxes[idx].textContent = '';
        last.box.classList.remove('correct', 'incorrect');
        last.button.disabled = false;
        updateCheckButtonState();
      }
      // Hide the Japanese phrase whenever the user interacts with the undo button.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    /**
     * Efface toutes les lettres positionn√©es dans des cases incorrectes et
     * r√©active les boutons correspondants. Cette fonction est appel√©e
     * lorsqu'on clique sur le bouton "reprendre" (üò©). Elle parcourt
     * l'historique des clics pour identifier les entr√©es qui se trouvent
     * dans des cases marqu√©es comme incorrectes (classe CSS ¬´¬†incorrect¬†¬ª),
     * puis r√©tablit l'√©tat initial de ces cases et des boutons de kana.
     */
    function resumeIncorrect() {
      // Parcourir l'historique en sens inverse pour supprimer les entr√©es
      // sans perturber les indices restants.
      for (let i = clickHistory.length - 1; i >= 0; i--) {
        const entry = clickHistory[i];
        const box = entry.box;
        if (box.classList.contains('incorrect')) {
          // R√©initialiser la case et le romaji correspondant
          const idx = boxes.indexOf(box);
          box.textContent = '';
          if (idx !== -1) {
            romajiBoxes[idx].textContent = '';
          }
          // Retirer les classes d'√©tat
          box.classList.remove('correct', 'incorrect');
          // R√©activer le bouton de kana
          if (entry.button) {
            entry.button.disabled = false;
          }
          // Retirer cette entr√©e de l'historique
          clickHistory.splice(i, 1);
        }
      }
      // Cacher la phrase japonaise et le bouton "reprendre"
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      // Mettre √† jour l'√©tat du bouton V√©rifier
      updateCheckButtonState();
      // Masquer le bouton reprendre apr√®s utilisation
      const resumeBtn = document.getElementById('resumeButton');
      if (resumeBtn) {
        resumeBtn.style.display = 'none';
      }
    }

    function showHint() {
      // Hide the Japanese phrase when requesting a hint.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      const i = boxes.findIndex(b => b.textContent === '');
      if (i !== -1) {
        lastHintedBox = boxes[i];
        lastHintedBox.textContent = boxes.correct[i];
        lastHintedBox.style.opacity = '0.5';
        hintCount++;
        hintCountSpan.textContent = hintCount;
        hintActive = true;
        // Incr√©menter le nombre total d'indices utilis√©s et mettre √† jour les statistiques
        globalHintTotal++;
        if (typeof updateStatsDisplay === 'function') updateStatsDisplay();
      }
    }

    function hideHint() {
      if (hintActive && lastHintedBox) {
        lastHintedBox.textContent = '';
        lastHintedBox.style.opacity = '1';
        lastHintedBox = null;
        hintActive = false;
      }
      // Hide the Japanese phrase when the hint is released.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    function nextPhrase() {
      currentIndex = (currentIndex + 1) % phrases.length;
      loadPhrase(currentIndex);
      // Hide the Japanese phrase when moving to the next phrase.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    // Naviguer vers la phrase pr√©c√©dente
    function prevPhrase() {
      currentIndex = (currentIndex - 1 + phrases.length) % phrases.length;
      loadPhrase(currentIndex);
      // Cacher la phrase japonaise lors du passage √† la phrase pr√©c√©dente
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    // Choisir une phrase al√©atoire
    function randomPhrase() {
      if (!phrases || phrases.length === 0) return;
      let randIndex = Math.floor(Math.random() * phrases.length);
      // √©viter de r√©p√©ter la m√™me phrase imm√©diatement si possible
      if (phrases.length > 1 && randIndex === currentIndex) {
        randIndex = (randIndex + 1) % phrases.length;
      }
      currentIndex = randIndex;
      loadPhrase(currentIndex);
      // Cacher la phrase japonaise puisqu'une nouvelle phrase est tir√©e
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    fetch("phrases_100.json")
      .then(res => res.json())
      .then(json => { phrases = json; loadPhrase(currentIndex); })
      .catch(e => { instruction.innerHTML = "<p>Erreur de chargement des donn√©es.</p>"; console.error(e); });
  
    let savedState = [];
    let totalSolutionCount = 0;

    function showSolutionPreview() {
      const totalSpan = document.getElementById('solutionCount');
      const localSpan = document.getElementById('localSolutionCount');

      totalSolutionCount++;
      if (totalSpan) totalSpan.textContent = totalSolutionCount;
      if (localSpan) localSpan.textContent = parseInt(localSpan.textContent || '0') + 1;
      // Mettre √† jour les statistiques dynamiques lorsque l'utilisateur consulte une solution
      if (typeof updateStatsDisplay === 'function') updateStatsDisplay();

      if (totalSolutionCount === 5) {
        alert("üëÅÔ∏è Tu aimes un peu trop tricher, non ? üòÑ");
      }

      savedState = boxes.map((box, i) => ({
        text: box.textContent,
        classList: [...box.classList],
        romaji: romajiBoxes[i].textContent
      }));

      /*
       * Lors de l‚Äôaper√ßu de la solution nous ne voulons pas colorer les
       * cases en vert comme si elles √©taient valid√©es. Le vert est
       * r√©serv√© √† la v√©rification finale quand l‚Äôutilisateur trouve
       * lui‚Äëm√™me la bonne r√©ponse. Au lieu d‚Äôajouter la classe
       * ¬´¬†correct¬†¬ª ici, on retire toutes les classes d‚Äô√©tat et on
       * applique uniquement la classe ¬´¬†highlight-preview¬†¬ª qui colore
       * en jaune clair. Cela √©vite la confusion signal√©e par l‚Äôutilisateur
       * (toutes les cases devenaient vertes) et permet de distinguer
       * clairement un simple aper√ßu de la vraie validation.
       */
      boxes.forEach((box, i) => {
        // placer le caract√®re correct dans chaque case
        box.textContent = boxes.correct[i];
        // supprimer les classes d‚Äô√©tat existantes pour un affichage neutre
        box.classList.remove('correct', 'incorrect');
        // appliquer uniquement la classe de surlignage provisoire
        box.classList.add('highlight-preview');
        // afficher aussi le romaji associ√©
        romajiBoxes[i].textContent = boxes.romajiList[i];
      });
    }

    function restorePreviousState() {
      savedState.forEach((state, i) => {
        boxes[i].textContent = state.text;
        boxes[i].className = 'box';
        state.classList.forEach(cls => boxes[i].classList.add(cls));
        boxes[i].classList.remove('highlight-preview');
        romajiBoxes[i].textContent = state.romaji;
      });
    }

</script>
<div id="macronInfo" style="display:none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 90%; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999;">
<p style="font-size: 1em; text-align:left;">
    Dans certains mots (comme ici) contenant "ou", comme <strong>gakkou</strong>, la transcription correcte selon le syst√®me Hepburn est <strong>gakk≈ç</strong> (avec un ≈ç long).
    <br><br>Mais ici, nous utilisons <strong>gakkou</strong> car cela correspond mieux √† la structure en hiragana :<br> „Åå (ga) + „Å£ (petit tsu) + „Åì (ko) + „ÅÜ (u).
    <br><br>Cela facilite l‚Äôapprentissage de l‚Äô√©criture en japonais - et c'est incontournable pour cet exercice ;-)
  </p>
<!-- Bouton pour fermer la fen√™tre d'information sur les macrons -->
<button onclick="document.getElementById('macronInfo').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<script>
function maybeAddInfoButton() {
  const romajiEl = document.querySelector('.romaji-line');
  if (!romajiEl) return;
  const existingBtn = document.getElementById('infoButton');
  if (existingBtn) existingBtn.remove();

  if (romajiEl.textContent.includes("ou")) {
    const infoBtn = document.createElement("button");
    infoBtn.textContent = "‚ÑπÔ∏è";
    infoBtn.title = "Pourquoi 'gakkou' et pas 'gakk≈ç' ?";
    infoBtn.id = "infoButton";
    infoBtn.style.marginLeft = "10px";
    infoBtn.style.fontSize = "0.9em";
    infoBtn.style.cursor = "pointer";
    infoBtn.onclick = () => {
      document.getElementById("macronInfo").style.display = "block";
    };
    romajiEl.appendChild(infoBtn);
  }
}

// Intercepter loadPhrase pour y ins√©rer l‚Äôappel √† maybeAddInfoButton
const originalLoadPhrase = loadPhrase;
loadPhrase = function(index) {
  originalLoadPhrase(index);
  setTimeout(maybeAddInfoButton, 30);
}

// La fiche d'utilisation est d√©sormais accessible via le menu Aide.
// On ne cr√©e plus de bouton s√©par√© dans le titre.

// Ajouter la bo√Æte popup √† la fin du body
const usageDiv = document.createElement('div');
usageDiv.id = 'usagePopup';
usageDiv.style.display = 'none';
usageDiv.style.position = 'fixed';
usageDiv.style.top = '10%';
usageDiv.style.left = '50%';
usageDiv.style.transform = 'translateX(-50%)';
usageDiv.style.backgroundColor = '#fff';
usageDiv.style.border = '2px solid #666';
usageDiv.style.padding = '1em';
usageDiv.style.borderRadius = '10px';
usageDiv.style.maxWidth = '90%';
usageDiv.style.maxHeight = '80%';
usageDiv.style.overflowY = 'auto';
usageDiv.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
usageDiv.style.zIndex = '9999';
usageDiv.innerHTML = `<div style="text-align:center;">
  <h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
  <p style="font-style:italic; font-size:1em; text-align:center;">par CilMac ‚Äì juillet 2025</p>
  <div style="text-align:left;">
    <h3>üéØ Objectif</h3>
    <p>S'entra√Æner √† reconstituer des phrases japonaises simples en <strong>hiragana</strong> (version katakana √† l'√©tude üòâ), √† partir de leur <em>romaji</em> et de leur traduction fran√ßaise. Version multisupports (ordi, tablette, smartphone).</p>

    <h3>üß© Fonctionnement de base</h3>
    <ol>
      <li>Une phrase en <strong>romaji</strong> + traduction fran√ßaise est affich√©e.</li>
      <li>Des boutons m√©lang√©s proposent les <strong>hiragana</strong> √† cliquer dans l'ordre.</li>
      <li>Quand toutes les cases sont remplies, le bouton <strong>V√©rifier</strong> s‚Äôactive.</li>
      <li>Si c'est juste ‚Üí tout passe en vert. Sinon ‚Üí erreurs en rouge.</li>
    </ol>

    <h3>‚ú® Fonctions utiles</h3>
    <ul>
      <li><strong>üò© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
      <li><strong>üí° Indice</strong> : propose un caract√®re correct temporaire.</li>
      <li><strong>üëÅÔ∏è Solution</strong> : affiche temporairement la r√©ponse compl√®te.</li>
      <li><strong>‚Üê Annuler</strong> : retire la derni√®re lettre saisie.</li>
      <li><strong>RAZ</strong> : recommence la phrase en cours.</li>
	<li><strong>‚¨ÖÔ∏è Pr√©c√©dente</strong> : phrase pr√©c√©dente.</li>
	<li><strong>‚û°Ô∏è Suivante</strong> : phrase suivante.</li>
	<li><strong>üé≤ Al√©atoire</strong> : phrase tir√©e au sort.</li>
	<li><strong>Rafra√Æchir</strong> la page Web : nouvelle session, repart √† z√©ro.</li>
	<li><strong>Menu gauche</strong> : tableaux des caract√®res japonais.</li>
	<li><strong>Menu droit</strong> : ressources diverses, dont un lien vers le site de la NHK, une mine d'or sur le Japon (langue, actualit√©s, recettes...).</li>
    </ul>

    <h3>üôè Remerciements...</h3>
 	<ul>
	<li>Un poil de ‚òïÔ∏è</li>
	<li>Plume, b√™ta testeuse üòò</li>
	<li>Chazouf üêà‚Äç‚¨õ üòâ</li>
    <h3></li>
    </ul>
  </div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button>`;
document.body.appendChild(usageDiv);
</script><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
  <h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
  <p style="font-style:italic; font-size:1em; text-align:center;">par CilMac ‚Äì juillet 2025</p>
  <div style="text-align:left;">
    <h3>üéØ Objectif</h3>
    <p>S'entra√Æner √† reconstituer des phrases japonaises simples en <strong>hiragana</strong> (version katakana √† l'√©tude üòâ), √† partir de leur <em>romaji</em> et de leur traduction fran√ßaise. Version multisupports (ordi, tablette, smartphone).</p>

    <h3>üß© Fonctionnement de base</h3>
    <ol>
      <li>Une phrase en <strong>romaji</strong> + traduction fran√ßaise est affich√©e.</li>
      <li>Des boutons m√©lang√©s proposent les <strong>hiragana</strong> √† cliquer dans l'ordre.</li>
      <li>Quand toutes les cases sont remplies, le bouton <strong>V√©rifier</strong> s‚Äôactive.</li>
      <li>Si c'est juste ‚Üí tout passe en vert. Sinon ‚Üí erreurs en rouge.</li>
    </ol>

    <h3>‚ú® Fonctions utiles</h3>
    <ul>
      <li><strong>üò© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
      <li><strong>üí° Indice</strong> : propose un caract√®re correct temporaire.</li>
      <li><strong>üëÅÔ∏è Solution</strong> : affiche temporairement la r√©ponse compl√®te.</li>
      <li><strong>‚Üê Annuler</strong> : retire la derni√®re lettre saisie.</li>
      <li><strong>RAZ</strong> : recommence la phrase en cours.</li>
	<li><strong>‚¨ÖÔ∏è Pr√©c√©dente</strong> : phrase pr√©c√©dente.</li>
	<li><strong>‚û°Ô∏è Suivante</strong> : phrase suivante.</li>
	<li><strong>üé≤ Al√©atoire</strong> : phrase tir√©e au sort.</li>
	<li><strong>Rafra√Æchir</strong> la page Web : nouvelle session, repart √† z√©ro.</li>
	<li><strong>Menu gauche</strong> : tableaux des caract√®res japonais.</li>
	<li><strong>Menu droit</strong> : ressources diverses, dont un lien vers le site de la NHK, une mine d'or sur le Japon (langue, actualit√©s, recettes...).</li>
    </ul>

    <h3>üôè Remerciements...</h3>
 	<ul>
	<li>Un poil de ‚òïÔ∏è</li>
	<li>Plume, b√™ta testeuse üòò</li>
	<li>Chazouf üêà‚Äç‚¨õ üòâ</li>
    <h3>
    </h3></ul>
  </div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
  <h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
  <p style="font-style:italic; font-size:1em; text-align:center;">par CilMac ‚Äì juillet 2025</p>
  <div style="text-align:left;">
    <h3>üéØ Objectif</h3>
    <p>S'entra√Æner √† reconstituer des phrases japonaises simples en <strong>hiragana</strong> (version katakana √† l'√©tude üòâ), √† partir de leur <em>romaji</em> et de leur traduction fran√ßaise. Version multisupports (ordi, tablette, smartphone).</p>

    <h3>üß© Fonctionnement de base</h3>
    <ol>
      <li>Une phrase en <strong>romaji</strong> + traduction fran√ßaise est affich√©e.</li>
      <li>Des boutons m√©lang√©s proposent les <strong>hiragana</strong> √† cliquer dans l'ordre.</li>
      <li>Quand toutes les cases sont remplies, le bouton <strong>V√©rifier</strong> s‚Äôactive.</li>
      <li>Si c'est juste ‚Üí tout passe en vert. Sinon ‚Üí erreurs en rouge.</li>
    </ol>

    <h3>‚ú® Fonctions utiles</h3>
    <ul>
      <li><strong>üò© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
      <li><strong>üí° Indice</strong> : propose un caract√®re correct temporaire.</li>
      <li><strong>üëÅÔ∏è Solution</strong> : affiche temporairement la r√©ponse compl√®te.</li>
      <li><strong>‚Üê Annuler</strong> : retire la derni√®re lettre saisie.</li>
      <li><strong>RAZ</strong> : recommence la phrase en cours.</li>
	<li><strong>‚¨ÖÔ∏è Pr√©c√©dente</strong> : phrase pr√©c√©dente.</li>
	<li><strong>‚û°Ô∏è Suivante</strong> : phrase suivante.</li>
	<li><strong>üé≤ Al√©atoire</strong> : phrase tir√©e au sort.</li>
	<li><strong>Rafra√Æchir</strong> la page Web : nouvelle session, repart √† z√©ro.</li>
	<li><strong>Menu gauche</strong> : tableaux des caract√®res japonais.</li>
	<li><strong>Menu droit</strong> : ressources diverses, dont un lien vers le site de la NHK, une mine d'or sur le Japon (langue, actualit√©s, recettes...).</li>
    </ul>

    <h3>‚ÑπÔ∏è Pour m√©moire</h3>
    <p>Parfois <code>gakkou</code> est affich√© au lieu de <code>gakk≈ç</code> : c‚Äôest pour mieux coller aux hiragana.</p>

    <h3>
    
  </h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
<h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
<p style="font-style:italic; font-size:1em; text-align:center;">par CilMac ‚Äì juillet 2025</p>
<div style="text-align:left;">
<h3>üéØ Objectif</h3>
<p>S'entra√Æner √† reconstituer des phrases japonaises simples en <strong>hiragana</strong>, √† partir de leur <em>romaji</em> et de leur traduction fran√ßaise. Multisupports (ordi, tablette, smartphone).</p>
<h3>üß© Fonctionnement de base</h3>
<ol>
<li>Une phrase en <strong>romaji</strong> + traduction fran√ßaise est affich√©e.</li>
<li>Des boutons m√©lang√©s proposent les <strong>hiragana</strong> √† cliquer dans l'ordre.</li>
<li>Quand toutes les cases sont remplies, le bouton <strong>V√©rifier</strong> s‚Äôactive.</li>
<li>Si c'est juste ‚Üí tout passe en vert. Sinon ‚Üí erreurs en rouge.</li>
</ol>
<h3>‚ú® Fonctions utiles</h3>
<ul>
<li><strong>üò© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
<li><strong>üí° Indice</strong> : propose un caract√®re correct temporaire.</li>
<li><strong>üëÅÔ∏è Solution</strong> : affiche temporairement la r√©ponse compl√®te.</li>
<li><strong>‚Üê Annuler</strong> : retire la derni√®re lettre saisie.</li>
<li><strong>RAZ</strong> : recommence la phrase en cours.</li>
<li><strong>Rafra√Æchir</strong> la page Web : nouvelle session, repart √† z√©ro.</li>
<li><strong>Kana</strong> : affiche un tableau des hiragana / katakana.</li>
<li><strong>Aide</strong> : affiche un mode op / un pdf de la NHK sur le japonais (avec lien vers le site).</li>
</ul>
<h3>üìÇ Donn√©es</h3>
<p>Les phrases viennent du fichier <code>phrases_100.json</code> (hiragana + romaji + fran√ßais).</p>
<h3>‚ÑπÔ∏è Astuce</h3>
<p>Parfois <code>gakkou</code> est affich√© au lieu de <code>gakk≈ç</code> : c‚Äôest pour mieux coller aux hiragana.</p>
<h3>
</h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
<h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
<p style="font-style:italic; font-size:1em; text-align:center;">par CilMac ‚Äì juillet 2025</p>
<div style="text-align:left;">
<h3>üéØ Objectif</h3>
<p>S'entra√Æner √† reconstituer des phrases japonaises simples en <strong>hiragana</strong>, √† partir de leur <em>romaji</em> et de leur traduction fran√ßaise.</p>
<h3>üß© Fonctionnement de base</h3>
<ol>
<li>Une phrase en <strong>romaji</strong> + traduction fran√ßaise est affich√©e.</li>
<li>Des boutons m√©lang√©s proposent les <strong>hiragana</strong> √† cliquer dans l'ordre.</li>
<li>Quand toutes les cases sont remplies, le bouton <strong>V√©rifier</strong> s‚Äôactive.</li>
<li>Si c'est juste ‚Üí tout passe en vert. Sinon ‚Üí erreurs en rouge.</li>
</ol>
<h3>‚ú® Fonctions utiles</h3>
<ul>
<li><strong>üò© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
<li><strong>üí° Indice</strong> : propose un caract√®re correct temporaire.</li>
<li><strong>üëÅÔ∏è Solution</strong> : affiche temporairement la r√©ponse compl√®te.</li>
<li><strong>‚Üê Annuler</strong> : retire la derni√®re lettre saisie.</li>
<li><strong>RAZ</strong> : recommence la phrase en cours.</li>
<li><strong>Rafra√Æchir</strong> la page Web : nouvelle session, repart √† z√©ro.</li>
</ul>
<h3>üìÇ Donn√©es</h3>
<p>Les phrases viennent du fichier <code>phrases_100.json</code> (hiragana + romaji + fran√ßais).</p>
<h3>‚ÑπÔ∏è Astuce</h3>
<p>Parfois <code>gakkou</code> est affich√© au lieu de <code>gakk≈ç</code> : c‚Äôest pour mieux coller aux hiragana.</p>
<h3>
</h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
<h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
<p style="font-style:italic; font-size:1em; text-align:center;">par CilMac ‚Äì juillet 2025</p>
<div style="text-align:left;">
<h3>üéØ Objectif</h3>
<p>S'entra√Æner √† reconstituer des phrases japonaises simples en <strong>hiragana</strong>, √† partir de leur <em>romaji</em> et de leur traduction fran√ßaise.</p>
<h3>üß© Fonctionnement de base</h3>
<ol>
<li>Une phrase en <strong>romaji</strong> + traduction fran√ßaise est affich√©e.</li>
<li>Des boutons m√©lang√©s proposent les <strong>hiragana</strong> √† cliquer dans l'ordre.</li>
<li>Quand toutes les cases sont remplies, le bouton <strong>V√©rifier</strong> s‚Äôactive.</li>
<li>Si c'est juste ‚Üí tout passe en vert. Sinon ‚Üí erreurs en rouge.</li>
</ol>
<h3>‚ú® Fonctions utiles</h3>
<ul>
<li><strong>üò© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
<li><strong>üí° Indice</strong> : propose un caract√®re correct temporaire.</li>
<li><strong>üëÅÔ∏è Solution</strong> : affiche temporairement la r√©ponse compl√®te.</li>
<li><strong>‚Üê Annuler</strong> : retire la derni√®re lettre saisie.</li>
<li><strong>RAZ</strong> : recommence la phrase en cours.</li>
<li><strong>Rafra√Æchir</strong> la page Web : nouvelle session, repart √† z√©ro.</li>
</ul>
<h3>üìÇ Donn√©es</h3>
<p>Les phrases viennent du fichier <code>phrases_100.json</code> (hiragana + romaji + fran√ßais).</p>
<h3>‚ÑπÔ∏è Astuce</h3>
<p>Parfois <code>gakkou</code> est affich√© au lieu de <code>gakk≈ç</code> : c‚Äôest pour mieux coller aux hiragana.</p>
<h3>
</h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div>
<!-- Fen√™tre popup avec l‚Äôimage Hiragana -->
<div id="hiraganaPopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 95%; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999; text-align: center;">
<h2>Tableau Hiragana</h2>
<img alt="Tableau Hiragana" src="Hiragana%20stats%20Agent%20V2_fichiers/nhk_hiragana.png" style="max-width: 100%; height: auto; touch-action: pinch-zoom;">
<br>
<button onclick="document.getElementById('hiraganaPopup').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<!-- Fen√™tre popup Katakana -->
<div id="katakanaPopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 95%; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999; text-align: center;">
<h2>Tableau Katakana</h2>
<img alt="Tableau Katakana" src="Hiragana%20stats%20Agent%20V2_fichiers/nhk_katakana.png" style="max-width: 100%; height: auto; touch-action: pinch-zoom;">
<br>
<button onclick="document.getElementById('katakanaPopup').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<!-- Fen√™tre popup Statistiques -->
<div id="statsPopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 90%; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999; text-align: center;">
  <h2 style="font-weight: bold;">Statistiques de l‚Äôexercice</h2>
  <p>Dur√©e totale&nbsp;: <span id="statTotalDuration">0 min 21 s</span></p>
  <p>Temps moyen par phrase&nbsp;: <span id="statAvgTimePerPhrase">0 s</span></p>
  <p>Phrases v√©rifi√©es&nbsp;: <span id="statPhrasesVerified">0</span></p>
  <p>Succ√®s sans aide&nbsp;: <span id="statSuccessNoHelp">0</span> / <span id="statSuccessDenom">0</span> (<span id="statSuccessPercent">0</span>&nbsp;%)</p>
  <p>Indices utilis√©s&nbsp;: <span id="statHintsUsed">0</span></p>
  <p>Solutions consult√©es&nbsp;: <span id="statSolutionsUsed">0</span></p>
  <p>Moyenne d‚Äôerreurs par phrase&nbsp;: <span id="statAvgErrors">0</span></p>
  <p>Phrase la plus longue r√©ussie sans aide&nbsp;: <span id="statLongestPhrase">Aucune</span></p>
  <button onclick="document.getElementById('statsPopup').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<script>
(function(){
  // KANA
  var kanaMenu = document.getElementById('tableauxMenu');
  if (kanaMenu && kanaMenu.parentElement) {
    var kanaContainer = kanaMenu.parentElement;
    var kanaButton = kanaContainer.querySelector('button');
    if (kanaButton) {
      kanaButton.addEventListener('click', function(ev){
        ev.stopPropagation();
        kanaMenu.style.display = (kanaMenu.style.display === 'block') ? 'none' : 'block';
      });
    }
  }

  // AIDE
  var aideMenu = document.getElementById('aideMenu');
  if (aideMenu && aideMenu.parentElement) {
    var aideContainer = aideMenu.parentElement;
    var aideButton = aideContainer.querySelector('button');
    if (aideButton) {
      aideButton.addEventListener('click', function(ev){
        ev.stopPropagation();
        aideMenu.style.display = (aideMenu.style.display === 'block') ? 'none' : 'block';
      });
    }
  }

  // Fermer en cliquant √† l'ext√©rieur
  window.addEventListener('click', function(e){
    if (kanaMenu && !kanaMenu.contains(e.target)) { kanaMenu.style.display = 'none'; }
    if (aideMenu && !aideMenu.contains(e.target)) { aideMenu.style.display = 'none'; }
  });
})();
</script>
<!-- Script pour mettre √† jour les statistiques dynamiques de l'exercice -->
<script>
// Met √† jour l'ensemble des statistiques toutes les secondes afin que la dur√©e totale
// et le temps moyen par phrase restent √† jour m√™me si la fen√™tre reste ouverte.
setInterval(function() {
  if (typeof updateStatsDisplay === 'function') {
    updateStatsDisplay();
  }
}, 1000);

// Fonction de mise √† jour des statistiques affich√©es dans la modale ¬´¬†Stats¬†¬ª
function updateStatsDisplay() {
  // Calculer la dur√©e totale √©coul√©e depuis l'ouverture de la page
  var now = Date.now();
  var diffMs = now - pageStartTime;
  var diffSec = Math.floor(diffMs / 1000);
  var totalMin = Math.floor(diffSec / 60);
  var totalSec = diffSec % 60;
  var totalDurationEl = document.getElementById('statTotalDuration');
  if (totalDurationEl) {
    totalDurationEl.textContent = totalMin + ' min ' + totalSec + ' s';
  }
  // Nombre de phrases v√©rifi√©es et succ√®s sans aide
  var verified = totalCheckCount;
  var successNoHelp = successWithoutHelpCount;
  var successDenomEl = document.getElementById('statSuccessDenom');
  var successNoHelpEl = document.getElementById('statSuccessNoHelp');
  var successPercentEl = document.getElementById('statSuccessPercent');
  var verifiedEl = document.getElementById('statPhrasesVerified');
  if (verifiedEl) verifiedEl.textContent = verified;
  if (successNoHelpEl) successNoHelpEl.textContent = successNoHelp;
  if (successDenomEl) successDenomEl.textContent = verified;
  var percent = (verified > 0) ? Math.round((successNoHelp / verified) * 100) : 0;
  if (successPercentEl) successPercentEl.textContent = percent;
  // Temps moyen par phrase
  var avgTimeEl = document.getElementById('statAvgTimePerPhrase');
  if (avgTimeEl) {
    if (verified > 0) {
      var avgSecTotal = diffMs / 1000 / verified;
      var avgMin = Math.floor(avgSecTotal / 60);
      var avgSec = Math.round(avgSecTotal % 60);
      if (avgMin > 0) {
        avgTimeEl.textContent = avgMin + ' min ' + avgSec + ' s';
      } else {
        avgTimeEl.textContent = avgSec + ' s';
      }
    } else {
      avgTimeEl.textContent = '0 s';
    }
  }
  // Affichage des indices utilis√©s
  var hintsEl = document.getElementById('statHintsUsed');
  if (hintsEl) hintsEl.textContent = globalHintTotal;
  // Affichage des solutions consult√©es
  var solEl = document.getElementById('statSolutionsUsed');
  if (solEl) solEl.textContent = totalSolutionCount;
  // Moyenne d'erreurs par phrase
  var avgErrEl = document.getElementById('statAvgErrors');
  if (avgErrEl) {
    if (verified > 0) {
      var avgErr = totalErrorCount / verified;
      avgErr = Math.round(avgErr * 10) / 10;
      // Utiliser une virgule comme s√©parateur d√©cimal pour le fran√ßais
      avgErrEl.textContent = avgErr.toFixed(1).replace('.', ',');
    } else {
      avgErrEl.textContent = '0';
    }
  }
  // Phrase la plus longue r√©ussie sans aide
  var longestEl = document.getElementById('statLongestPhrase');
  if (longestEl) {
    if (bestLongestLength > 0 && bestLongestPhraseIndex >= 0) {
      longestEl.textContent = 'Phrase ' + (bestLongestPhraseIndex + 1) + ' (' + bestLongestLength + ' caract√®res)';
    } else {
      longestEl.textContent = 'Aucune';
    }
  }
}
</script>

<script>
function preventDoubleClickOnMobile(btnId, handlerDown, handlerUp) {
  let touched = false;
  const btn = document.getElementById(btnId);
  if (!btn) return;

  btn.addEventListener('touchstart', function(e) {
    touched = true;
    if (handlerDown) handlerDown(e);
  }, { passive: false });

  btn.addEventListener('touchend', function(e) {
    touched = false;
    if (handlerUp) handlerUp(e);
    e.preventDefault();
  }, { passive: false });

  btn.addEventListener('mousedown', function(e) {
    if (!touched && handlerDown) handlerDown(e);
  });

  btn.addEventListener('mouseup', function(e) {
    if (!touched && handlerUp) handlerUp(e);
  });

  btn.addEventListener('click', function(e) {
    if (touched) {
      e.preventDefault();
      return false;
    }
  });
}

// Appliquer sur les boutons Indice (üí°) et Solution (üëÅÔ∏è)
document.addEventListener("DOMContentLoaded", function () {
  preventDoubleClickOnMobile('hintButton', showHint, hideHint);
  preventDoubleClickOnMobile('solutionButton', showSolutionPreview, restorePreviousState);
});
</script>

<script>
// Gestion de la synth√®se vocale et des voix hommes/femmes
document.addEventListener("DOMContentLoaded", function () {
  // Ces variables stockent les noms des voix s√©lectionn√©es selon le genre
  let maleVoiceName = null;
  let femaleVoiceName = null;
  let selectedVoiceName = null;
  let isFemaleVoiceSelected = true;

  // Chargement et classification des voix disponibles (langue japonaise uniquement)
  function loadVoices() {
    const allVoices = window.speechSynthesis.getVoices();
    const jaVoices = allVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('ja'));
    maleVoiceName = null;
    femaleVoiceName = null;
    // Heuristiques bas√©es sur les noms courants pour diff√©rencier les voix masculines et f√©minines
    const femalePatterns = /(kyoko|mizuki|nanami|sayaka|haruka|hikari|tsukasa|kana|yui|female|woman)/i;
    const malePatterns = /(otoya|show|shin|takumi|ren|taichi|ichi|male|man|male voice)/i;
    jaVoices.forEach(v => {
      const lowerName = v.name.toLowerCase();
      if (!femaleVoiceName && femalePatterns.test(lowerName)) {
        femaleVoiceName = v.name;
      }
      if (!maleVoiceName && malePatterns.test(lowerName)) {
        maleVoiceName = v.name;
      }
    });
    // Par d√©faut, la premi√®re voix est utilis√©e comme voix f√©minine si aucune n'est d√©tect√©e
    if (!femaleVoiceName) {
      femaleVoiceName = jaVoices[0] ? jaVoices[0].name : null;
    }
    // La deuxi√®me voix (s'il y en a une) est utilis√©e comme voix masculine si non d√©tect√©e, sinon identique √† la f√©minine
    if (!maleVoiceName) {
      maleVoiceName = jaVoices[1] ? jaVoices[1].name : femaleVoiceName;
    }
    // Choisir la voix s√©lectionn√©e en fonction du genre actuel
    selectedVoiceName = isFemaleVoiceSelected ? femaleVoiceName : maleVoiceName;
    // Mettre √† jour l'ic√¥ne du bouton de bascule
    const toggleBtn = document.getElementById('voiceToggle');
    if (toggleBtn) {
      toggleBtn.textContent = isFemaleVoiceSelected ? 'üë©' : 'üë®';
    }
  }
  // Charger imm√©diatement les voix et recharger lorsqu'elles changent (notamment sur Safari/iOS)
  loadVoices();
  if (typeof window.speechSynthesis !== 'undefined' && 'onvoiceschanged' in window.speechSynthesis) {
    window.speechSynthesis.addEventListener('voiceschanged', loadVoices);
  }

  // Fonction pour lire la phrase japonaise avec la voix s√©lectionn√©e
  window.playJapaneseAudio = function () {
    const currentPhrase = typeof phrases !== "undefined" ? phrases[currentIndex] : null;
    if (!currentPhrase || !currentPhrase.jp) return;
    const jpText = currentPhrase.jp;
    const utterance = new window.SpeechSynthesisUtterance(jpText);
    utterance.lang = 'ja-JP';
    utterance.rate = 0.85;
    const voices = window.speechSynthesis.getVoices();
    if (voices && voices.length) {
      const voice = voices.find(v => v.name === selectedVoiceName && v.lang && v.lang.toLowerCase().startsWith('ja'));
      if (voice) {
        utterance.voice = voice;
      }
    }
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
  };
  // G√©rer le clic sur le bouton audio pour lancer la lecture
  const btn = document.getElementById("audioButton");
  if (btn) {
    btn.addEventListener("click", function () {
      window.playJapaneseAudio();
    });
  }
  // G√©rer le clic sur le bouton de bascule de voix
  const toggleBtn = document.getElementById('voiceToggle');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', function () {
      isFemaleVoiceSelected = !isFemaleVoiceSelected;
      selectedVoiceName = isFemaleVoiceSelected ? femaleVoiceName : maleVoiceName;
      toggleBtn.textContent = isFemaleVoiceSelected ? 'üë©' : 'üë®';
    });
  }
});
</script>




<!-- Message de bienvenue (popup + audio) -->
<audio id="audioBienvenue" src="bienvenue.mp3" preload="auto"></audio>

<!-- Overlay pour bloquer les interactions tant que la popup est ouverte -->
<div id="popupOverlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.3); z-index: 9998;"></div>

<div id="popupBienvenue" style="display:none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
    background-color: white; border: 2px solid #ccc; padding: 1.5em; border-radius: 12px;
    box-shadow: 0 0 12px rgba(0,0,0,0.3); z-index: 9999; text-align: center; max-width: 90%;">
  <div style="color: #d9534f; margin-bottom: 0.3em; font-weight: normal; font-size: 1.5em;">„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åõ</div>
  <button onclick="document.getElementById('audioBienvenue').play()" 
          style="background:none; border:none; font-size: 1.5em; cursor:pointer;" 
          title="√âcouter le message de bienvenue">üå∏üé∂</button>
  <p style="color: #003399; font-style: italic; font-size: 1.1em; margin-top: 0.5em;">‚Äì bienvenue ‚Äì</p>
  <button onclick="
    document.getElementById('popupBienvenue').style.display='none';
    document.getElementById('popupOverlay').style.display='none';
    window.popupActive = false;
    if (typeof window.playJapaneseAudio === 'function') window.playJapaneseAudio();
  " style="margin-top: 1em; padding: 6px 12px;">Fermer</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    window.popupActive = false;
    const dejaVu = sessionStorage.getItem("bienvenueJoue");
    const popup = document.getElementById("popupBienvenue");
    const overlay = document.getElementById("popupOverlay");

    if (!dejaVu && popup && overlay) {
      window.popupActive = true;
      popup.style.display = "block";
      overlay.style.display = "block";
      sessionStorage.setItem("bienvenueJoue", "oui");
    } else {
      // Pas de popup : on lit directement la phrase
      if (typeof window.playJapaneseAudio === 'function') {
        window.playJapaneseAudio();
      }
    }
  });
</script>

</body>
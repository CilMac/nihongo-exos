<!DOCTYPE html>
<html lang="fr"><head>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" name="viewport">
<meta content="text/html; charset=UTF-8" http-equiv="content-type">
<meta charset="utf-8">
<!-- Mise Ã  jour du titre de la page pour reflÃ©ter l'exercice avec un drapeau japonais -->
<title>Hiragana </title>
<style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; text-align: center; }
    .instruction { font-size: 1.2em; margin-bottom: 10px; }
    /*
      The container that holds the romaji and hiragana boxes was previously defined
      as a grid with a fixed number of columns. On narrower screens (and even on
      desktop when the answer contains many characters) this caused the row of
      boxes to overflow off the right side of the page. To allow the boxes to
      wrap naturally when there isnâ€™t enough horizontal space, switch this
      container to use flexbox with wrapping enabled. Each box still has a
      fixed width (40px), so flexbox will automatically break to a new line
      whenever a row is full. The container width is set to 100% to ensure it
      doesn't grow beyond the viewport, preventing overflow, and centering is
      maintained with auto margins.
    */
    .grid-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
      margin-bottom: 5px;
      width: 100%;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    .romaji-box { height: 20px; font-size: 14px; line-height: 20px; text-align: center; width: 40px; }
    .box { width: 40px; height: 40px; border: 2px solid #333; font-size: 24px; line-height: 40px; background-color: white; text-align: center; }
    .box.correct { background-color: #c8f7c5; }
    .box.incorrect { background-color: #f9c0c0; }
    #buttons { margin-top: 10px; }
    #buttons button { margin: 5px; font-size: 20px; padding: 5px 10px; }
    #buttons button:disabled { background-color: #d0e6ff; color: #555; }
    .buttons { margin-top: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .buttons button { font-size: 24px; padding: 12px 24px; border-radius: 10px; background-color: #eeeeee; border: 2px solid #aaa; }
    .buttons button:hover { background-color: #d8eaff; cursor: pointer; }
    .feedback { font-weight: bold; font-size: 1.2em; margin-top: 15px; }
    /* Style pour le titre principal de la page */
    h1#appTitle {
      font-size: 2em;
      margin-bottom: 20px;
    }
    #appTitle {
      text-align: center;
      margin-bottom: 20px;
    }

    .title-main {
      font-size: 2em;
      font-weight: bold;
    }

    .title-signature {
      font-size: 0.9em;
      color: #666;
      font-family: serif;
      opacity: 0.8;
      margin-top: 4px; 
    }

    /* Indicateur discret de position de la phrase */
    .phrase-counter {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
    }
    /* Styling for the instruction lines: romaji (normal), Japanese (red) and hidden by default, and French (dark blue) */
    .romaji-line {
      font-style: normal;
      font-weight: normal;
    }
    .jp-line {
      color: red;
      font-weight: normal;
      display: none; /* hidden until the user provides a correct answer */
    }
    .fr-line {
      color: #00008B;
      font-weight: normal;
    }
  
    .highlight-preview {
      background-color: #fff5c2 !important;
      box-shadow: 0 0 8px #f0c040;
      transform: scale(1.05);
      transition: transform 0.1s ease;
    }
    
    .action-button {
      font-size: 1.2em;
      padding: 0.4em 1em;
      margin: 0.2em;
      border-radius: 8px;
      border: 2px solid #888;
      background-color: #f0f0f0;
      transition: background-color 0.2s ease;
    }
    .action-button:hover {
      background-color: #e0e0e0 !important;
    }
    .help-button {
      background-color: #d5f5d5 !important;
    }
    .help-button:disabled {
      background-color: #cccccc !important;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .buttons-row {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      margin-top: 30px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    @media (min-width: 600px) {
      .buttons-row {
        flex-direction: column;
        align-items: center;
      }

      .button-group {
        flex-direction: row;
        justify-content: center;
      }
    }

@media (max-width: 768px) {
  #appTitle {
    gap: 8px !important;
  }
  #appTitle .title-main {
    font-size: 1.5em !important;
  }
  .grid-container {
    transform: scale(0.95);
  }
  .buttons-row {
    flex-direction: column !important;
  }
  .button-group {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
  }
  button {
    font-size: 1em !important;
  }
}


@media screen and (max-width: 768px) and (orientation: portrait) {
  #usagePopup, #macronInfo {
    width: 95vw !important;
    left: 2.5vw !important;
    right: auto !important;
    transform: none !important;
    max-width: none !important;
    border-radius: 12px !important;
    box-sizing: border-box;
  }
}

@media (max-width: 600px) and (orientation: portrait) {
  #statsPopup, .popup {
    min-width: 92vw !important;
    left: 50% !important;
    right: auto !important;
    transform: translateX(-50%) !important;
    border-radius: 14px !important;
  }
}

@media (max-width: 600px) {
  #audioButton {
    top: 0.32em !important;
  }
}
</style>
</head>
<body>
<!-- Titre principal affichÃ© en haut de la page -->

<div style="position: relative; text-align: center; margin-bottom: 10px; min-height: 56px;">
  <span class="title-main" style="font-size:2em; font-weight:bold; margin:0; display:inline-block;">Hiragana</span>
  <button id="audioButton" style="position: absolute; left: 50%; transform: translateX(90px); top: -0.18em;
      font-size:1.6em; padding:2px 8px; background:none; border:none; outline:none; box-shadow:none; cursor:pointer;" title="Lire le message vocal">ğŸ§</button>
  <!-- Bouton de bascule voix homme/femme : trÃ¨s compact (icÃ´nes ğŸ‘©/ğŸ‘¨) -->
  <button id="voiceToggle" style="position: absolute; left: 50%; transform: translateX(140px); top: -0.18em;
      font-size:1.6em; padding:2px 4px; background:none; border:none; outline:none; box-shadow:none; cursor:pointer;" title="Choisir voix homme/femme">ğŸ‘©</button>
  
</div>
<div style="text-align:center; margin-bottom:20px;"><div style="position: relative; display: inline-block;">
<button style="font-size:1.2em;" title="Tableaux de caractÃ¨res japonais">ğŸ–‹ï¸  ã‚ ã‚¢ æ–‡ â–¼</button>

<div id="tableauxMenu" style="display: none; position: absolute; background-color: white; min-width: 120px;
                box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1; border: 1px solid #ccc; border-radius: 6px;">
  <button onclick="window.open('nhk_hiragana.png', '_blank');" style="width:100%;  font-size:1em;  padding: 8px; padding-left: 12px; text-align: left" title="Afficher le tableau des hiragana">ã‚ Hiragana</button>
  <button onclick="window.open('nhk_katakana.png', '_blank');" style="width:100%;  font-size:1em;  padding: 8px; padding-left: 12px; text-align: left" title="Afficher le tableau des katakana">ã‚¢ Katakana</button>
  <button onclick="window.open('hiragana_dessins.png', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Afficher les dessins Hiragana Ã©coliers">ã‚ Ã©coliers</button>
  <button onclick="window.open('katakana_dessins.png', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Afficher les dessins Katakana Ã©coliers">ã‚¢ Ã©coliers</button>
  <button onclick="window.open('100_kanji.pdf', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Ouvrir la liste des 100 kanji les plus frÃ©quents">æ–‡ Kanji</button>
</div>

</div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<div style="position: relative; display: inline-block;">
<button style="font-size:1.2em;" title="Aide, infos, statistiques">ğŸ“–  Infos â–¼</button>
<div id="aideMenu" style="display: none; position: absolute; background-color: white; min-width: 140px;
                box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1; border: 1px solid #ccc; border-radius: 6px;">
<!-- PremiÃ¨re option : ouvrir la fiche d'utilisation (ancienne icÃ´ne ğŸ“‹) -->
<button onclick="document.getElementById('usagePopup').style.display='block';" style="width:100%;  font-size:1em;  padding: 8px; ;  text-align: left; padding-left: 12px; text-align: left" title="Afficher la fiche d'utilisation de l'exercice">ğŸ—’ï¸ Mode op.</button>
<!-- Autre option d'aide : lien vers le PDF NHK -->
<button onclick="window.open('nhk_le_japonais.pdf', '_blank');" style="width:100%;  font-size:1em;  padding: 8px; ;  text-align: left; padding-left: 12px; text-align: left" title="Ouvrir le PDF NHK ã‚„ã•ã—ã„æ—¥æœ¬èª">ğŸ“• NHK PDF </button>
<!-- Ajout d'une option menant au site NHK en ligne -->
<button onclick="window.open('https://www3.nhk.or.jp/nhkworld/lesson/french/', '_blank');" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Visiter le site NHK web">ğŸŒ NHK web</button>
<!-- Option pour afficher la fenÃªtre des statistiques -->
<button onclick="document.getElementById('statsPopup').style.display='block';" style="width:100%; font-size:1em; padding: 8px; padding-left: 12px; text-align: left" title="Afficher les statistiques">ğŸ“ˆ Stats</button>
</div>
</div></div>
<div class="instruction" id="instruction"><p>Erreur de chargement des donnÃ©es.</p></div>
<!-- Removed the standalone jpPhrase element because the Japanese text will now be
       displayed inside the instruction block itself when appropriate. -->
<!-- <div class="feedback" id="jpPhrase" style="color: red;"></div> -->
<div class="grid-container" id="romaji-container"></div>
<div class="grid-container" id="phrase-container"></div>
<div id="buttons"></div>
<div class="buttons-row">
<div class="button-group">
<!--
        Bouton Â«Â reprendreÂ Â» : n'est affichÃ© que lorsqu'une rÃ©ponse erronÃ©e
        est dÃ©tectÃ©e lors de la vÃ©rification. Il se place juste Ã  gauche
        du bouton VÃ©rifier et affiche uniquement une icÃ´ne Â«Â ğŸ˜©Â Â». Au clic,
        il efface toutes les cases incorrectes et restaure les boutons de
        kana correspondants, mimant l'action d'annuler ces entrÃ©es.
      -->
<button class="action-button help-button" id="resumeButton" onclick="resumeIncorrect()" style="display: none;" title="RÃ©initialiser uniquement les erreurs">ğŸ˜©</button>
<button class="action-button help-button" disabled="disabled" id="checkButton" onclick="checkAnswer()">VÃ©rifier</button>
<button class="action-button" id="resetButton" onclick="clearBoxes()" title="RÃ©initialiser la saisie"><span style="color:red">RAZ</span></button>
<button class="action-button" id="backspaceButton" onclick="undoLast()" title="Annuler la derniÃ¨re lettre">â†</button>
<button class="action-button help-button" id="hintButton" title="Afficher un indice temporaire">ğŸ’¡</button>
<button class="action-button help-button" id="solutionButton" title="Afficher temporairement la solution">ğŸ‘ï¸</button>
</div>
<div class="button-group">
<button class="action-button" id="prevButton" onclick="prevPhrase()" title="Phrase prÃ©cÃ©dente">â¬…ï¸</button>
<button class="action-button" id="nextButton" onclick="nextPhrase()" title="Phrase suivante">â¡ï¸</button>
<button class="action-button" id="randomButton" onclick="randomPhrase()" title="Phrase alÃ©atoire">ğŸ²</button>
</div>
</div>
<div class="feedback" id="feedback"></div>
<!-- Indicateur discret affichant la position actuelle de la phrase -->
<div class="phrase-counter" id="phraseCounter"></div>
<div class="phrase-counter">Indices utilisÃ©s sur cette page : <span id="hintCount">0</span><br>
    Total solutions consultÃ©es : <span id="solutionCount">0</span><br>
    dont sur cette page : <span id="localSolutionCount">0</span></div>
<script>
    let phrases = [], currentIndex = 0, boxes = [], romajiBoxes = [], clickHistory = [], hintCount = 0;
    // DÃ©but de la page pour calculer la durÃ©e Ã©coulÃ©e
    let pageStartTime = Date.now();
    // Compteurs de statistiques : succÃ¨s sans aide et nombre total de vÃ©rifications
    let successWithoutHelpCount = 0;
    let totalCheckCount = 0;
    let hintActive = false, lastHintedBox = null;

    const phraseContainer = document.getElementById('phrase-container');
    const romajiContainer = document.getElementById('romaji-container');
    const buttonsContainer = document.getElementById('buttons');
    const instruction = document.getElementById('instruction');
    const feedback = document.getElementById('feedback');
    const hintCountSpan = document.getElementById('hintCount');
    const checkButton = document.getElementById('checkButton');
    const clickAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAD//f39/f39");
const victoryAudio = new Audio("victory.mp3");
    // Ã‰lÃ©ment d'indicateur de numÃ©ro de phrase
    const phraseCounter = document.getElementById('phraseCounter');

    const charToRomaji = {
      'ã‚':'a','ã„':'i','ã†':'u','ãˆ':'e','ãŠ':'o','ã‹':'ka','ã':'ki','ã':'ku','ã‘':'ke','ã“':'ko',
      'ãŒ':'ga','ã':'gi','ã':'gu','ã’':'ge','ã”':'go','ã•':'sa','ã—':'shi','ã™':'su','ã›':'se','ã':'so',
      'ã–':'za','ã˜':'ji','ãš':'zu','ãœ':'ze','ã':'zo','ãŸ':'ta','ã¡':'chi','ã¤':'tsu','ã¦':'te','ã¨':'to',
      'ã ':'da','ã§':'de','ã©':'do','ãª':'na','ã«':'ni','ã¬':'nu','ã­':'ne','ã®':'no','ã¯':'ha','ã²':'hi',
      'ãµ':'fu','ã¸':'he','ã»':'ho','ã°':'ba','ã³':'bi','ã¶':'bu','ã¹':'be','ã¼':'bo','ã¾':'ma','ã¿':'mi',
      'ã‚€':'mu','ã‚':'me','ã‚‚':'mo','ã‚„':'ya','ã‚†':'yu','ã‚ˆ':'yo','ã‚‰':'ra','ã‚Š':'ri','ã‚‹':'ru','ã‚Œ':'re',
      'ã‚':'ro','ã‚':'wa','ã‚’':'o','ã‚“':'n','ã£':'','ã‚ƒ':'ya','ã‚…':'yu','ã‚‡':'yo','ãƒ¼':'', 'ã€œ':'',
      'ãƒ•':'fu','ãƒ©':'ra','ãƒ³':'n','ã‚¹':'su','ã‚¸':'ji','ãƒ§':'yo','ãƒˆ':'to','ã‚«':'ka','ãƒ‰':'do'
    };

    function hiraganaToRomajiCluster(cluster) {
      return cluster.split('').map(c => charToRomaji[c] || '').join('');
    }

    function loadPhrase(index) {
  const backBtn = document.getElementById("backspaceButton");
  if (backBtn) backBtn.disabled = false;
  const hintBtn = document.getElementById("hintButton");
  const solBtn = document.getElementById("solutionButton");
  if (hintBtn) hintBtn.disabled = false;
  if (solBtn) solBtn.disabled = false;
  document.getElementById("hintButton").disabled = false;
  document.getElementById("solutionButton").disabled = false;
      const localSpan = document.getElementById('localSolutionCount');
      if (localSpan) localSpan.textContent = '0';
      const phrase = phrases[index];
      const rawChars = phrase.kana.trim().split(' ');
      const romajiList = rawChars.map(hiraganaToRomajiCluster);
      boxes = []; romajiBoxes = []; clickHistory = [];
      hintCount = 0;
      hintCountSpan.textContent = hintCount;
      feedback.textContent = '';
      // Hide any previously displayed Japanese phrase at the start of a new phrase.
      const jpReset = document.getElementById('jpPhrase');
      if (jpReset) {
        jpReset.textContent = '';
        jpReset.style.display = 'none';
      }
      checkButton.disabled = true;
      // Cacher le bouton "reprendre" au chargement d'une nouvelle phrase
      const resumeBtnInit = document.getElementById('resumeButton');
      if (resumeBtnInit) {
        resumeBtnInit.style.display = 'none';
      }
      // Construct the instruction block with romaji, a placeholder for the Japanese phrase,
      // and the French translation. The Japanese line remains hidden until the answer
      // is validated as correct.
      instruction.innerHTML =
        `<p class="romaji-line">${phrase.romaji}</p>` +
        `<p id="jpPhrase" class="jp-line"></p>` +
        `<p class="fr-line">${phrase.fr}</p>`;

      // Mettre Ã  jour l'indicateur de position de la phrase
      if (phraseCounter) {
        phraseCounter.textContent = `Phrase ${index + 1} / ${phrases.length}`;
      }

      phraseContainer.style.gridTemplateColumns = `repeat(${rawChars.length}, 40px)`;
      romajiContainer.style.gridTemplateColumns = `repeat(${rawChars.length}, 40px)`;
      phraseContainer.innerHTML = ''; romajiContainer.innerHTML = ''; buttonsContainer.innerHTML = '';

      rawChars.forEach((_, i) => {
        const rBox = document.createElement('div');
        rBox.className = 'romaji-box';
        romajiContainer.appendChild(rBox);
        romajiBoxes.push(rBox);
        const box = document.createElement('div');
        box.className = 'box';
        phraseContainer.appendChild(box);
        boxes.push(box);
      });

      const shuffled = rawChars.slice().sort(() => Math.random() - 0.5);
      shuffled.forEach(char => {
        const btn = document.createElement('button');
        btn.textContent = char;
        btn.onclick = () => { clickAudio.play(); insertCharacter(char, btn); };
        buttonsContainer.appendChild(btn);
      });

      boxes.correct = rawChars;
      boxes.romajiList = romajiList;
      // Lire automatiquement la phrase japonaise aprÃ¨s chargement
      if (typeof window.playJapaneseAudio === 'function') {
        window.playJapaneseAudio();
      }
    }

    function insertCharacter(char, button) {
      const emptyBox = boxes.find(b => b.textContent === '');
      if (emptyBox) {
        emptyBox.textContent = char;
        button.disabled = true;
        clickHistory.push({box: emptyBox, button});
        updateCheckButtonState();
      }
    }

    function updateCheckButtonState() {
      checkButton.disabled = !boxes.every(b => b.textContent !== '');
    }

    function checkAnswer() {
  const backBtn = document.getElementById("backspaceButton");
  const hintBtn = document.getElementById("hintButton");
  const solBtn = document.getElementById("solutionButton");
      boxes.forEach((box, i) => {
        box.classList.remove('correct', 'incorrect');
        if (box.textContent === boxes.correct[i]) {
          box.classList.add('correct');
          romajiBoxes[i].textContent = boxes.romajiList[i] || '';
        } else {
          box.classList.add('incorrect');
          romajiBoxes[i].textContent = '';
        }
      });
      const result = boxes.map(b => b.textContent).join('') === boxes.correct.join('');
      
      if (result) {
        const hintUsed = parseInt(document.getElementById('hintCount').textContent || '0');
        const solUsed = parseInt(document.getElementById('localSolutionCount').textContent || '0');
        if (hintUsed === 0 && solUsed === 0) {
          feedback.textContent = 'âœ… Bravo, sans aide ! ğŸ‘';
          victoryAudio.play();
        } else {
          feedback.textContent = 'Mouais, trouvÃ© avec de l\'aide...ğŸ‘';
        }
      } else {
        feedback.textContent = 'âŒ Essaie encore';
      }
    
      // GÃ©rer l'affichage du bouton "reprendre" selon le rÃ©sultat et la prÃ©sence d'erreurs.
      const resumeBtn = document.getElementById('resumeButton');
      if (!result && boxes.some(b => b.classList.contains('incorrect'))) {
        // Afficher le bouton uniquement si des cases sont incorrectes.
        if (resumeBtn) {
          resumeBtn.style.display = 'inline-block';
        }
      } else {
        if (resumeBtn) {
          resumeBtn.style.display = 'none';
        }
      }

      // Afficher la phrase japonaise seulement si tout est correct
      const jpElement = document.getElementById('jpPhrase');
      if (result) {
        jpElement.textContent = phrases[currentIndex].jp;
        jpElement.style.display = 'block';
        if (hintBtn) hintBtn.disabled = true;
        if (solBtn) solBtn.disabled = true;
        if (backBtn) backBtn.disabled = true;
      } else {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
        if (hintBtn) hintBtn.disabled = false;
        if (solBtn) solBtn.disabled = false;
        if (backBtn) backBtn.disabled = false;
      }

      // Mettre Ã  jour les statistiques : incrÃ©menter le nombre total de vÃ©rifications et les succÃ¨s sans aide
      totalCheckCount++;
      // Nombre d'indices et de solutions utilisÃ©s pour cette phrase
      const hintsUsedNow = parseInt(document.getElementById('hintCount').textContent || '0');
      const solutionsUsedNow = parseInt(document.getElementById('localSolutionCount').textContent || '0');
      if (result && hintsUsedNow === 0 && solutionsUsedNow === 0) {
        successWithoutHelpCount++;
      }
      // Mettre Ã  jour l'affichage dans la modale de statistiques si elle est prÃ©sente
      const successEl = document.getElementById('successCount');
      const totalEl = document.getElementById('totalCheckCount');
      if (successEl) successEl.textContent = successWithoutHelpCount;
      if (totalEl) totalEl.textContent = totalCheckCount;
    }

    function clearBoxes() {
  const backBtn = document.getElementById("backspaceButton");
  if (backBtn) backBtn.disabled = false;
  const hintBtn = document.getElementById("hintButton");
  const solBtn = document.getElementById("solutionButton");
  if (hintBtn) hintBtn.disabled = false;
  if (solBtn) solBtn.disabled = false;
  document.getElementById("hintButton").disabled = false;
  document.getElementById("solutionButton").disabled = false;
      boxes.forEach((box, i) => {
        box.textContent = '';
        box.classList.remove('correct', 'incorrect');
        romajiBoxes[i].textContent = '';
      });
      document.querySelectorAll('#buttons button').forEach(b => b.disabled = false);
      clickHistory = [];
      feedback.textContent = '';
      // Hide the Japanese phrase when clearing the boxes.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      updateCheckButtonState();

      // Masquer le bouton "reprendre" lorsque l'on rÃ©initialise tout
      const resumeBtn = document.getElementById('resumeButton');
      if (resumeBtn) {
        resumeBtn.style.display = 'none';
      }
    }

    function undoLast() {
      const last = clickHistory.pop();
      if (last) {
        const idx = boxes.indexOf(last.box);
        last.box.textContent = '';
        romajiBoxes[idx].textContent = '';
        last.box.classList.remove('correct', 'incorrect');
        last.button.disabled = false;
        updateCheckButtonState();
      }
      // Hide the Japanese phrase whenever the user interacts with the undo button.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    /**
     * Efface toutes les lettres positionnÃ©es dans des cases incorrectes et
     * rÃ©active les boutons correspondants. Cette fonction est appelÃ©e
     * lorsqu'on clique sur le bouton "reprendre" (ğŸ˜©). Elle parcourt
     * l'historique des clics pour identifier les entrÃ©es qui se trouvent
     * dans des cases marquÃ©es comme incorrectes (classe CSS Â«Â incorrectÂ Â»),
     * puis rÃ©tablit l'Ã©tat initial de ces cases et des boutons de kana.
     */
    function resumeIncorrect() {
      // Parcourir l'historique en sens inverse pour supprimer les entrÃ©es
      // sans perturber les indices restants.
      for (let i = clickHistory.length - 1; i >= 0; i--) {
        const entry = clickHistory[i];
        const box = entry.box;
        if (box.classList.contains('incorrect')) {
          // RÃ©initialiser la case et le romaji correspondant
          const idx = boxes.indexOf(box);
          box.textContent = '';
          if (idx !== -1) {
            romajiBoxes[idx].textContent = '';
          }
          // Retirer les classes d'Ã©tat
          box.classList.remove('correct', 'incorrect');
          // RÃ©activer le bouton de kana
          if (entry.button) {
            entry.button.disabled = false;
          }
          // Retirer cette entrÃ©e de l'historique
          clickHistory.splice(i, 1);
        }
      }
      // Cacher la phrase japonaise et le bouton "reprendre"
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      // Mettre Ã  jour l'Ã©tat du bouton VÃ©rifier
      updateCheckButtonState();
      // Masquer le bouton reprendre aprÃ¨s utilisation
      const resumeBtn = document.getElementById('resumeButton');
      if (resumeBtn) {
        resumeBtn.style.display = 'none';
      }
    }

    function showHint() {
      // Hide the Japanese phrase when requesting a hint.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
      const i = boxes.findIndex(b => b.textContent === '');
      if (i !== -1) {
        lastHintedBox = boxes[i];
        lastHintedBox.textContent = boxes.correct[i];
        lastHintedBox.style.opacity = '0.5';
        hintCount++;
        hintCountSpan.textContent = hintCount;
        hintActive = true;
      }
    }

    function hideHint() {
      if (hintActive && lastHintedBox) {
        lastHintedBox.textContent = '';
        lastHintedBox.style.opacity = '1';
        lastHintedBox = null;
        hintActive = false;
      }
      // Hide the Japanese phrase when the hint is released.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    function nextPhrase() {
      currentIndex = (currentIndex + 1) % phrases.length;
      loadPhrase(currentIndex);
      // Hide the Japanese phrase when moving to the next phrase.
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    // Naviguer vers la phrase prÃ©cÃ©dente
    function prevPhrase() {
      currentIndex = (currentIndex - 1 + phrases.length) % phrases.length;
      loadPhrase(currentIndex);
      // Cacher la phrase japonaise lors du passage Ã  la phrase prÃ©cÃ©dente
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    // Choisir une phrase alÃ©atoire
    function randomPhrase() {
      if (!phrases || phrases.length === 0) return;
      let randIndex = Math.floor(Math.random() * phrases.length);
      // Ã©viter de rÃ©pÃ©ter la mÃªme phrase immÃ©diatement si possible
      if (phrases.length > 1 && randIndex === currentIndex) {
        randIndex = (randIndex + 1) % phrases.length;
      }
      currentIndex = randIndex;
      loadPhrase(currentIndex);
      // Cacher la phrase japonaise puisqu'une nouvelle phrase est tirÃ©e
      const jpElement = document.getElementById('jpPhrase');
      if (jpElement) {
        jpElement.textContent = '';
        jpElement.style.display = 'none';
      }
    }

    fetch("phrases_100.json")
      .then(res => res.json())
      .then(json => { phrases = json; loadPhrase(currentIndex); })
      .catch(e => { instruction.innerHTML = "<p>Erreur de chargement des donnÃ©es.</p>"; console.error(e); });
  
    let savedState = [];
    let totalSolutionCount = 0;

    function showSolutionPreview() {
      const totalSpan = document.getElementById('solutionCount');
      const localSpan = document.getElementById('localSolutionCount');

      totalSolutionCount++;
      if (totalSpan) totalSpan.textContent = totalSolutionCount;
      if (localSpan) localSpan.textContent = parseInt(localSpan.textContent || '0') + 1;

      if (totalSolutionCount === 5) {
        alert("ğŸ‘ï¸ Tu aimes un peu trop tricher, non ? ğŸ˜„");
      }

      savedState = boxes.map((box, i) => ({
        text: box.textContent,
        classList: [...box.classList],
        romaji: romajiBoxes[i].textContent
      }));

      /*
       * Lors de lâ€™aperÃ§u de la solution nous ne voulons pas colorer les
       * cases en vert comme si elles Ã©taient validÃ©es. Le vert est
       * rÃ©servÃ© Ã  la vÃ©rification finale quand lâ€™utilisateur trouve
       * luiâ€‘mÃªme la bonne rÃ©ponse. Au lieu dâ€™ajouter la classe
       * Â«Â correctÂ Â» ici, on retire toutes les classes dâ€™Ã©tat et on
       * applique uniquement la classe Â«Â highlight-previewÂ Â» qui colore
       * en jaune clair. Cela Ã©vite la confusion signalÃ©e par lâ€™utilisateur
       * (toutes les cases devenaient vertes) et permet de distinguer
       * clairement un simple aperÃ§u de la vraie validation.
       */
      boxes.forEach((box, i) => {
        // placer le caractÃ¨re correct dans chaque case
        box.textContent = boxes.correct[i];
        // supprimer les classes dâ€™Ã©tat existantes pour un affichage neutre
        box.classList.remove('correct', 'incorrect');
        // appliquer uniquement la classe de surlignage provisoire
        box.classList.add('highlight-preview');
        // afficher aussi le romaji associÃ©
        romajiBoxes[i].textContent = boxes.romajiList[i];
      });
    }

    function restorePreviousState() {
      savedState.forEach((state, i) => {
        boxes[i].textContent = state.text;
        boxes[i].className = 'box';
        state.classList.forEach(cls => boxes[i].classList.add(cls));
        boxes[i].classList.remove('highlight-preview');
        romajiBoxes[i].textContent = state.romaji;
      });
    }

</script>
<div id="macronInfo" style="display:none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 90%; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999;">
<p style="font-size: 1em; text-align:left;">
    Dans certains mots (comme ici) contenant "ou", comme <strong>gakkou</strong>, la transcription correcte selon le systÃ¨me Hepburn est <strong>gakkÅ</strong> (avec un Å long).
    <br><br>Mais ici, nous utilisons <strong>gakkou</strong> car cela correspond mieux Ã  la structure en hiragana :<br> ãŒ (ga) + ã£ (petit tsu) + ã“ (ko) + ã† (u).
    <br><br>Cela facilite lâ€™apprentissage de lâ€™Ã©criture en japonais - et c'est incontournable pour cet exercice ;-)
  </p>
<!-- Bouton pour fermer la fenÃªtre d'information sur les macrons -->
<button onclick="document.getElementById('macronInfo').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<script>
function maybeAddInfoButton() {
  const romajiEl = document.querySelector('.romaji-line');
  if (!romajiEl) return;
  const existingBtn = document.getElementById('infoButton');
  if (existingBtn) existingBtn.remove();

  if (romajiEl.textContent.includes("ou")) {
    const infoBtn = document.createElement("button");
    infoBtn.textContent = "â„¹ï¸";
    infoBtn.title = "Pourquoi 'gakkou' et pas 'gakkÅ' ?";
    infoBtn.id = "infoButton";
    infoBtn.style.marginLeft = "10px";
    infoBtn.style.fontSize = "0.9em";
    infoBtn.style.cursor = "pointer";
    infoBtn.onclick = () => {
      document.getElementById("macronInfo").style.display = "block";
    };
    romajiEl.appendChild(infoBtn);
  }
}

// Intercepter loadPhrase pour y insÃ©rer lâ€™appel Ã  maybeAddInfoButton
const originalLoadPhrase = loadPhrase;
loadPhrase = function(index) {
  originalLoadPhrase(index);
  setTimeout(maybeAddInfoButton, 30);
}

// La fiche d'utilisation est dÃ©sormais accessible via le menu Aide.
// On ne crÃ©e plus de bouton sÃ©parÃ© dans le titre.

// Ajouter la boÃ®te popup Ã  la fin du body
const usageDiv = document.createElement('div');
usageDiv.id = 'usagePopup';
usageDiv.style.display = 'none';
usageDiv.style.position = 'fixed';
usageDiv.style.top = '10%';
usageDiv.style.left = '50%';
usageDiv.style.transform = 'translateX(-50%)';
usageDiv.style.backgroundColor = '#fff';
usageDiv.style.border = '2px solid #666';
usageDiv.style.padding = '1em';
usageDiv.style.borderRadius = '10px';
usageDiv.style.maxWidth = '90%';
usageDiv.style.maxHeight = '80%';
usageDiv.style.overflowY = 'auto';
usageDiv.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
usageDiv.style.zIndex = '9999';
usageDiv.innerHTML = `<div style="text-align:center;">
  <h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
  <p style="font-style:italic; font-size:1em; text-align:center;">par CilMac â€“ juillet 2025</p>
  <div style="text-align:left;">
    <h3>ğŸ¯ Objectif</h3>
    <p>S'entraÃ®ner Ã  reconstituer des phrases japonaises simples en <strong>hiragana</strong> (version katakana Ã  l'Ã©tude ğŸ˜‰), Ã  partir de leur <em>romaji</em> et de leur traduction franÃ§aise. Version multisupports (ordi, tablette, smartphone).</p>

    <h3>ğŸ§© Fonctionnement de base</h3>
    <ol>
      <li>Une phrase en <strong>romaji</strong> + traduction franÃ§aise est affichÃ©e.</li>
      <li>Des boutons mÃ©langÃ©s proposent les <strong>hiragana</strong> Ã  cliquer dans l'ordre.</li>
      <li>Quand toutes les cases sont remplies, le bouton <strong>VÃ©rifier</strong> sâ€™active.</li>
      <li>Si c'est juste â†’ tout passe en vert. Sinon â†’ erreurs en rouge.</li>
    </ol>

    <h3>âœ¨ Fonctions utiles</h3>
    <ul>
      <li><strong>ğŸ˜© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
      <li><strong>ğŸ’¡ Indice</strong> : propose un caractÃ¨re correct temporaire.</li>
      <li><strong>ğŸ‘ï¸ Solution</strong> : affiche temporairement la rÃ©ponse complÃ¨te.</li>
      <li><strong>â† Annuler</strong> : retire la derniÃ¨re lettre saisie.</li>
      <li><strong>RAZ</strong> : recommence la phrase en cours.</li>
	<li><strong>â¬…ï¸ PrÃ©cÃ©dente</strong> : phrase prÃ©cÃ©dente.</li>
	<li><strong>â¡ï¸ Suivante</strong> : phrase suivante.</li>
	<li><strong>ğŸ² AlÃ©atoire</strong> : phrase tirÃ©e au sort.</li>
	<li><strong>RafraÃ®chir</strong> la page Web : nouvelle session, repart Ã  zÃ©ro.</li>
	<li><strong>Menu gauche</strong> : tableaux des caractÃ¨res japonais.</li>
	<li><strong>Menu droit</strong> : ressources diverses, dont un lien vers le site de la NHK, une mine d'or sur le Japon (langue, actualitÃ©s, recettes...).</li>
    </ul>

    <h3>ğŸ™ Remerciements...</h3>
 	<ul>
	<li>Un poil de cafÃ©.</li>
	<li>Plume, bÃªta testeuse ğŸ˜˜</li>
	<li>Chazouf ğŸˆâ€â¬› ğŸ˜‰</li>
    <h3></li>
    </ul>
  </div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button>`;
document.body.appendChild(usageDiv);
</script><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
  <h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
  <p style="font-style:italic; font-size:1em; text-align:center;">par CilMac â€“ juillet 2025</p>
  <div style="text-align:left;">
    <h3>ğŸ¯ Objectif</h3>
    <p>S'entraÃ®ner Ã  reconstituer des phrases japonaises simples en <strong>hiragana</strong> (version katakana Ã  l'Ã©tude ğŸ˜‰), Ã  partir de leur <em>romaji</em> et de leur traduction franÃ§aise. Version multisupports (ordi, tablette, smartphone).</p>

    <h3>ğŸ§© Fonctionnement de base</h3>
    <ol>
      <li>Une phrase en <strong>romaji</strong> + traduction franÃ§aise est affichÃ©e.</li>
      <li>Des boutons mÃ©langÃ©s proposent les <strong>hiragana</strong> Ã  cliquer dans l'ordre.</li>
      <li>Quand toutes les cases sont remplies, le bouton <strong>VÃ©rifier</strong> sâ€™active.</li>
      <li>Si c'est juste â†’ tout passe en vert. Sinon â†’ erreurs en rouge.</li>
    </ol>

    <h3>âœ¨ Fonctions utiles</h3>
    <ul>
      <li><strong>ğŸ˜© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
      <li><strong>ğŸ’¡ Indice</strong> : propose un caractÃ¨re correct temporaire.</li>
      <li><strong>ğŸ‘ï¸ Solution</strong> : affiche temporairement la rÃ©ponse complÃ¨te.</li>
      <li><strong>â† Annuler</strong> : retire la derniÃ¨re lettre saisie.</li>
      <li><strong>RAZ</strong> : recommence la phrase en cours.</li>
	<li><strong>â¬…ï¸ PrÃ©cÃ©dente</strong> : phrase prÃ©cÃ©dente.</li>
	<li><strong>â¡ï¸ Suivante</strong> : phrase suivante.</li>
	<li><strong>ğŸ² AlÃ©atoire</strong> : phrase tirÃ©e au sort.</li>
	<li><strong>RafraÃ®chir</strong> la page Web : nouvelle session, repart Ã  zÃ©ro.</li>
	<li><strong>Menu gauche</strong> : tableaux des caractÃ¨res japonais.</li>
	<li><strong>Menu droit</strong> : ressources diverses, dont un lien vers le site de la NHK, une mine d'or sur le Japon (langue, actualitÃ©s, recettes...).</li>
    </ul>

    <h3>â„¹ï¸ Pour mÃ©moire</h3>
    <p>Parfois <code>gakkou</code> est affichÃ© au lieu de <code>gakkÅ</code> : câ€™est pour mieux coller aux hiragana.</p>

    <h3>
    
  </h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
<h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
<p style="font-style:italic; font-size:1em; text-align:center;">par CilMac â€“ juillet 2025</p>
<div style="text-align:left;">
<h3>ğŸ¯ Objectif</h3>
<p>S'entraÃ®ner Ã  reconstituer des phrases japonaises simples en <strong>hiragana</strong>, Ã  partir de leur <em>romaji</em> et de leur traduction franÃ§aise. Multisupports (ordi, tablette, smartphone).</p>
<h3>ğŸ§© Fonctionnement de base</h3>
<ol>
<li>Une phrase en <strong>romaji</strong> + traduction franÃ§aise est affichÃ©e.</li>
<li>Des boutons mÃ©langÃ©s proposent les <strong>hiragana</strong> Ã  cliquer dans l'ordre.</li>
<li>Quand toutes les cases sont remplies, le bouton <strong>VÃ©rifier</strong> sâ€™active.</li>
<li>Si c'est juste â†’ tout passe en vert. Sinon â†’ erreurs en rouge.</li>
</ol>
<h3>âœ¨ Fonctions utiles</h3>
<ul>
<li><strong>ğŸ˜© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
<li><strong>ğŸ’¡ Indice</strong> : propose un caractÃ¨re correct temporaire.</li>
<li><strong>ğŸ‘ï¸ Solution</strong> : affiche temporairement la rÃ©ponse complÃ¨te.</li>
<li><strong>â† Annuler</strong> : retire la derniÃ¨re lettre saisie.</li>
<li><strong>RAZ</strong> : recommence la phrase en cours.</li>
<li><strong>RafraÃ®chir</strong> la page Web : nouvelle session, repart Ã  zÃ©ro.</li>
<li><strong>Kana</strong> : affiche un tableau des hiragana / katakana.</li>
<li><strong>Aide</strong> : affiche un mode op / un pdf de la NHK sur le japonais (avec lien vers le site).</li>
</ul>
<h3>ğŸ“‚ DonnÃ©es</h3>
<p>Les phrases viennent du fichier <code>phrases_100.json</code> (hiragana + romaji + franÃ§ais).</p>
<h3>â„¹ï¸ Astuce</h3>
<p>Parfois <code>gakkou</code> est affichÃ© au lieu de <code>gakkÅ</code> : câ€™est pour mieux coller aux hiragana.</p>
<h3>
</h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
<h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
<p style="font-style:italic; font-size:1em; text-align:center;">par CilMac â€“ juillet 2025</p>
<div style="text-align:left;">
<h3>ğŸ¯ Objectif</h3>
<p>S'entraÃ®ner Ã  reconstituer des phrases japonaises simples en <strong>hiragana</strong>, Ã  partir de leur <em>romaji</em> et de leur traduction franÃ§aise.</p>
<h3>ğŸ§© Fonctionnement de base</h3>
<ol>
<li>Une phrase en <strong>romaji</strong> + traduction franÃ§aise est affichÃ©e.</li>
<li>Des boutons mÃ©langÃ©s proposent les <strong>hiragana</strong> Ã  cliquer dans l'ordre.</li>
<li>Quand toutes les cases sont remplies, le bouton <strong>VÃ©rifier</strong> sâ€™active.</li>
<li>Si c'est juste â†’ tout passe en vert. Sinon â†’ erreurs en rouge.</li>
</ol>
<h3>âœ¨ Fonctions utiles</h3>
<ul>
<li><strong>ğŸ˜© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
<li><strong>ğŸ’¡ Indice</strong> : propose un caractÃ¨re correct temporaire.</li>
<li><strong>ğŸ‘ï¸ Solution</strong> : affiche temporairement la rÃ©ponse complÃ¨te.</li>
<li><strong>â† Annuler</strong> : retire la derniÃ¨re lettre saisie.</li>
<li><strong>RAZ</strong> : recommence la phrase en cours.</li>
<li><strong>RafraÃ®chir</strong> la page Web : nouvelle session, repart Ã  zÃ©ro.</li>
</ul>
<h3>ğŸ“‚ DonnÃ©es</h3>
<p>Les phrases viennent du fichier <code>phrases_100.json</code> (hiragana + romaji + franÃ§ais).</p>
<h3>â„¹ï¸ Astuce</h3>
<p>Parfois <code>gakkou</code> est affichÃ© au lieu de <code>gakkÅ</code> : câ€™est pour mieux coller aux hiragana.</p>
<h3>
</h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div><div id="usagePopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background-color: rgb(255, 255, 255); border: 2px solid rgb(102, 102, 102); padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 10px; z-index: 9999;"><div style="text-align:center;">
<h2 style="margin-top:0; text-align:center;">Fiche d'utilisation</h2>
<p style="font-style:italic; font-size:1em; text-align:center;">par CilMac â€“ juillet 2025</p>
<div style="text-align:left;">
<h3>ğŸ¯ Objectif</h3>
<p>S'entraÃ®ner Ã  reconstituer des phrases japonaises simples en <strong>hiragana</strong>, Ã  partir de leur <em>romaji</em> et de leur traduction franÃ§aise.</p>
<h3>ğŸ§© Fonctionnement de base</h3>
<ol>
<li>Une phrase en <strong>romaji</strong> + traduction franÃ§aise est affichÃ©e.</li>
<li>Des boutons mÃ©langÃ©s proposent les <strong>hiragana</strong> Ã  cliquer dans l'ordre.</li>
<li>Quand toutes les cases sont remplies, le bouton <strong>VÃ©rifier</strong> sâ€™active.</li>
<li>Si c'est juste â†’ tout passe en vert. Sinon â†’ erreurs en rouge.</li>
</ol>
<h3>âœ¨ Fonctions utiles</h3>
<ul>
<li><strong>ğŸ˜© Reprendre</strong> : efface uniquement les cases incorrectes.</li>
<li><strong>ğŸ’¡ Indice</strong> : propose un caractÃ¨re correct temporaire.</li>
<li><strong>ğŸ‘ï¸ Solution</strong> : affiche temporairement la rÃ©ponse complÃ¨te.</li>
<li><strong>â† Annuler</strong> : retire la derniÃ¨re lettre saisie.</li>
<li><strong>RAZ</strong> : recommence la phrase en cours.</li>
<li><strong>RafraÃ®chir</strong> la page Web : nouvelle session, repart Ã  zÃ©ro.</li>
</ul>
<h3>ğŸ“‚ DonnÃ©es</h3>
<p>Les phrases viennent du fichier <code>phrases_100.json</code> (hiragana + romaji + franÃ§ais).</p>
<h3>â„¹ï¸ Astuce</h3>
<p>Parfois <code>gakkou</code> est affichÃ© au lieu de <code>gakkÅ</code> : câ€™est pour mieux coller aux hiragana.</p>
<h3>
</h3></div>
</div>
<button onclick="document.getElementById('usagePopup').style.display='none';" style="margin-top: 10px; padding: 6px 12px;">Fermer</button></div>
<!-- FenÃªtre popup avec lâ€™image Hiragana -->
<div id="hiraganaPopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 95%; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999; text-align: center;">
<h2>Tableau Hiragana</h2>
<img alt="Tableau Hiragana" src="Hiragana%202%20voix%20emoji_fichiers/nhk_hiragana.png" style="max-width: 100%; height: auto; touch-action: pinch-zoom;">
<br>
<button onclick="document.getElementById('hiraganaPopup').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<!-- FenÃªtre popup Katakana -->
<div id="katakanaPopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 95%; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999; text-align: center;">
<h2>Tableau Katakana</h2>
<img alt="Tableau Katakana" src="Hiragana%202%20voix%20emoji_fichiers/nhk_katakana.png" style="max-width: 100%; height: auto; touch-action: pinch-zoom;">
<br>
<button onclick="document.getElementById('katakanaPopup').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<!-- FenÃªtre popup Statistiques -->
<div id="statsPopup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
    background-color: #fff; border: 2px solid #666; padding: 1em; border-radius: 10px;
    max-width: 90%; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999; text-align: center;">
<h2>Statistiques</h2>
<p>DurÃ©e depuis l'ouverture&nbsp;: <span id="timeElapsed">0 min 22 s</span></p>
<p>SuccÃ¨s sans aide&nbsp;: <span id="successCount">0</span> / <span id="totalCheckCount">0</span></p>
<button onclick="document.getElementById('statsPopup').style.display='none';" style="margin-top:10px; padding:6px 12px;">Fermer</button>
</div>
<script>
(function(){
  // KANA
  var kanaMenu = document.getElementById('tableauxMenu');
  if (kanaMenu && kanaMenu.parentElement) {
    var kanaContainer = kanaMenu.parentElement;
    var kanaButton = kanaContainer.querySelector('button');
    if (kanaButton) {
      kanaButton.addEventListener('click', function(ev){
        ev.stopPropagation();
        kanaMenu.style.display = (kanaMenu.style.display === 'block') ? 'none' : 'block';
      });
    }
  }

  // AIDE
  var aideMenu = document.getElementById('aideMenu');
  if (aideMenu && aideMenu.parentElement) {
    var aideContainer = aideMenu.parentElement;
    var aideButton = aideContainer.querySelector('button');
    if (aideButton) {
      aideButton.addEventListener('click', function(ev){
        ev.stopPropagation();
        aideMenu.style.display = (aideMenu.style.display === 'block') ? 'none' : 'block';
      });
    }
  }

  // Fermer en cliquant Ã  l'extÃ©rieur
  window.addEventListener('click', function(e){
    if (kanaMenu && !kanaMenu.contains(e.target)) { kanaMenu.style.display = 'none'; }
    if (aideMenu && !aideMenu.contains(e.target)) { aideMenu.style.display = 'none'; }
  });
})();
</script>
<!-- Script pour mettre Ã  jour l'affichage du temps Ã©coulÃ© dans la modale de statistiques -->
<script>
// Met Ã  jour l'horloge des statistiques toutes les secondes
setInterval(function() {
  var now = Date.now();
  var diff = Math.floor((now - pageStartTime) / 1000);
  var minutes = Math.floor(diff / 60);
  var seconds = diff % 60;
  var timeEl = document.getElementById('timeElapsed');
  if (timeEl) {
    timeEl.textContent = minutes + ' min ' + seconds + ' s';
  }
}, 1000);
</script>

<script>
function preventDoubleClickOnMobile(btnId, handlerDown, handlerUp) {
  let touched = false;
  const btn = document.getElementById(btnId);
  if (!btn) return;

  btn.addEventListener('touchstart', function(e) {
    touched = true;
    if (handlerDown) handlerDown(e);
  }, { passive: false });

  btn.addEventListener('touchend', function(e) {
    touched = false;
    if (handlerUp) handlerUp(e);
    e.preventDefault();
  }, { passive: false });

  btn.addEventListener('mousedown', function(e) {
    if (!touched && handlerDown) handlerDown(e);
  });

  btn.addEventListener('mouseup', function(e) {
    if (!touched && handlerUp) handlerUp(e);
  });

  btn.addEventListener('click', function(e) {
    if (touched) {
      e.preventDefault();
      return false;
    }
  });
}

// Appliquer sur les boutons Indice (ğŸ’¡) et Solution (ğŸ‘ï¸)
document.addEventListener("DOMContentLoaded", function () {
  preventDoubleClickOnMobile('hintButton', showHint, hideHint);
  preventDoubleClickOnMobile('solutionButton', showSolutionPreview, restorePreviousState);
});
</script>

<script>
// Gestion de la synthÃ¨se vocale et des voix hommes/femmes
document.addEventListener("DOMContentLoaded", function () {
  // Ces variables stockent les noms des voix sÃ©lectionnÃ©es selon le genre
  let maleVoiceName = null;
  let femaleVoiceName = null;
  let selectedVoiceName = null;
  let isFemaleVoiceSelected = true;

  // Chargement et classification des voix disponibles (langue japonaise uniquement)
  function loadVoices() {
    const allVoices = window.speechSynthesis.getVoices();
    const jaVoices = allVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('ja'));
    maleVoiceName = null;
    femaleVoiceName = null;
    // Heuristiques basÃ©es sur les noms courants pour diffÃ©rencier les voix masculines et fÃ©minines
    const femalePatterns = /(kyoko|mizuki|nanami|sayaka|haruka|hikari|tsukasa|kana|yui|female|woman)/i;
    const malePatterns = /(otoya|show|shin|takumi|ren|taichi|ichi|male|man|male voice)/i;
    jaVoices.forEach(v => {
      const lowerName = v.name.toLowerCase();
      if (!femaleVoiceName && femalePatterns.test(lowerName)) {
        femaleVoiceName = v.name;
      }
      if (!maleVoiceName && malePatterns.test(lowerName)) {
        maleVoiceName = v.name;
      }
    });
    // Par dÃ©faut, la premiÃ¨re voix est utilisÃ©e comme voix fÃ©minine si aucune n'est dÃ©tectÃ©e
    if (!femaleVoiceName) {
      femaleVoiceName = jaVoices[0] ? jaVoices[0].name : null;
    }
    // La deuxiÃ¨me voix (s'il y en a une) est utilisÃ©e comme voix masculine si non dÃ©tectÃ©e, sinon identique Ã  la fÃ©minine
    if (!maleVoiceName) {
      maleVoiceName = jaVoices[1] ? jaVoices[1].name : femaleVoiceName;
    }
    // Choisir la voix sÃ©lectionnÃ©e en fonction du genre actuel
    selectedVoiceName = isFemaleVoiceSelected ? femaleVoiceName : maleVoiceName;
    // Mettre Ã  jour l'icÃ´ne du bouton de bascule
    const toggleBtn = document.getElementById('voiceToggle');
    if (toggleBtn) {
      toggleBtn.textContent = isFemaleVoiceSelected ? 'ğŸ‘©' : 'ğŸ‘¨';
    }
  }
  // Charger immÃ©diatement les voix et recharger lorsqu'elles changent (notamment sur Safari/iOS)
  loadVoices();
  if (typeof window.speechSynthesis !== 'undefined' && 'onvoiceschanged' in window.speechSynthesis) {
    window.speechSynthesis.addEventListener('voiceschanged', loadVoices);
  }

  // Fonction pour lire la phrase japonaise avec la voix sÃ©lectionnÃ©e
  window.playJapaneseAudio = function () {
    const currentPhrase = typeof phrases !== "undefined" ? phrases[currentIndex] : null;
    if (!currentPhrase || !currentPhrase.jp) return;
    const jpText = currentPhrase.jp;
    const utterance = new window.SpeechSynthesisUtterance(jpText);
    utterance.lang = 'ja-JP';
    utterance.rate = 0.85;
    const voices = window.speechSynthesis.getVoices();
    if (voices && voices.length) {
      const voice = voices.find(v => v.name === selectedVoiceName && v.lang && v.lang.toLowerCase().startsWith('ja'));
      if (voice) {
        utterance.voice = voice;
      }
    }
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
  };
  // GÃ©rer le clic sur le bouton audio pour lancer la lecture
  const btn = document.getElementById("audioButton");
  if (btn) {
    btn.addEventListener("click", function () {
      window.playJapaneseAudio();
    });
  }
  // GÃ©rer le clic sur le bouton de bascule de voix
  const toggleBtn = document.getElementById('voiceToggle');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', function () {
      isFemaleVoiceSelected = !isFemaleVoiceSelected;
      selectedVoiceName = isFemaleVoiceSelected ? femaleVoiceName : maleVoiceName;
      toggleBtn.textContent = isFemaleVoiceSelected ? 'ğŸ‘©' : 'ğŸ‘¨';
    });
  }
});
</script>
</body></html>